<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—èšåˆæœç´¢</title>
    <link rel="icon" href="/static/icons/favicon-search.svg" />

    <!-- æœ¬åœ°èµ„æº -->
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="/static/css/element-plus.css" />
    <!-- Prism.js CSSä¸»é¢˜ -->
    <link rel="stylesheet" href="/static/css/prism-okaidia.min.css" />
    <!-- è‡ªå®šä¹‰CSS -->
    <link rel="stylesheet" href="/static/fonts/microsoft-yahei.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/groups.css" />
    <link rel="stylesheet" href="/static/css/search.css" />
    <link rel="stylesheet" href="/static/css/results.css" />
    <!-- ç´§å‡‘æ ·å¼è¦†ç›–ï¼Œç¼©å°æ•´ä½“å­—å·ä¸é—´è·çº¦10% -->
    <link rel="stylesheet" href="/static/css/compact.css" />
    <style>
        /* æ–‡ä»¶è¿‡æ»¤å™¨å±•å¼€/æŠ˜å è¿‡æ¸¡åŠ¨ç”» */
        .file-filter-enter-from,
        .file-filter-leave-to {
            max-height: 0;
            opacity: 0;
            transform: translateY(-4px);
        }
        .file-filter-enter-to,
        .file-filter-leave-from {
            max-height: 800px; /* å…è®¸è¶³å¤Ÿé«˜åº¦ */
            opacity: 1;
            transform: translateY(0);
        }
        .file-filter-enter-active,
        .file-filter-leave-active {
            overflow: hidden;
            transition: max-height .28s ease, opacity .25s ease, transform .28s ease;
        }
    </style>
    
    <!-- æœ¬åœ°JavaScriptåº“ -->
    <script src="/static/js/vendor/vue.global.js"></script>
    <script src="/static/js/vendor/element-plus.js"></script>
    <script src="/static/js/vendor/axios.min.js"></script>
    <!-- Prism.jsåº“ -->
    <script src="/static/js/vendor/prism-core.min.js"></script>
    <script src="/static/js/vendor/prism-markup.min.js"></script>
    <script src="/static/js/vendor/prism-clike.min.js"></script>
    <script src="/static/js/vendor/prism-javascript.min.js"></script>
    <script src="/static/js/vendor/prism-json.min.js"></script>
    <script src="/static/js/vendor/prism-sql.min.js"></script>
    <script src="/static/js/vendor/prism-xml-doc.min.js"></script>
    <!-- LogSearchResults ç»„ä»¶ -->
    <script src="/static/js/LogSearchResults.js"></script>

</head>

<body>
    <script>window.APP_PAGE="{{ page|default('') }}";</script>
    <div id="app">
        <div class="app-container">


            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- å·¦ä¾§æ—¥å¿—åˆ—è¡¨ -->
                <div class="left-panel">
                    <div class="panel-header">
                        <h3>ğŸ” æ—¥å¿—èšåˆæœç´¢</h3>
                    </div>
                    <div class="log-list" v-loading="logsLoading">
                        <div v-if="logs.length === 0 && !logsLoading" class="empty-state">
                            <div>æš‚æ— æ—¥å¿—é…ç½®</div>
                        </div>
                        
                        <!-- åˆ†ç»„æ˜¾ç¤º -->
                        <div v-for="group in groupedLogs" :key="group.name" class="log-group">
                            <!-- åˆ†ç»„æ ‡é¢˜ -->
                            <div class="group-header" @click="toggleGroup(group.name)">
                                <span class="group-name">[[ group.name ]]</span>
                                <span class="group-count">([[ group.logs.length ]])</span>
                                <span class="toggle-icon" :class="{ collapsed: group.isCollapsed }">â–¼</span>
                            </div>
                            
                            <!-- åˆ†ç»„å†…çš„æ—¥å¿—åˆ—è¡¨ -->
                            <div v-show="!group.isCollapsed" class="group-content">
                                <div v-for="log in group.logs" :key="log.name" class="log-item"
                                    :class="{ active: selectedLog?.name === log.name }" @click="selectLog(log)">
                                    <h4>[[ log.name ]]</h4>
                                    <p>[[ log.description || 'æš‚æ— æè¿°' ]]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ›´å¤šåŠŸèƒ½æŒ‰é’® -->
                    <div class="more-actions">
                        <button class="more-button" @click="toggleMoreMenu" :class="{ active: showMoreMenu }">
                            <span class="more-icon">âš™ï¸</span>
                            <span class="more-text">æ›´å¤šåŠŸèƒ½</span>
                            <span class="arrow-icon" :class="{ rotated: showMoreMenu }">â–¼</span>
                        </button>
                        
                        <!-- æ›´å¤šåŠŸèƒ½èœå• -->
                        <div v-show="showMoreMenu" class="more-menu">
                            <!-- æ—¥å¿—é…ç½®é¡µé¢å·²éšè— - ä¸å¼€æ”¾ç»™ç”¨æˆ·æ‰‹åŠ¨é…ç½®
                            <div class="menu-item" @click="navigateToPage('config')">
                                <span class="menu-icon">âš™ï¸</span>
                                <span class="menu-text">æ—¥å¿—é…ç½®</span>
                            </div>
                            -->
                            <div class="menu-item" @click="navigateToPage('sftp')">
                                <span class="menu-icon">ğŸ“</span>
                                <span class="menu-text">æ–‡ä»¶ç®¡ç†</span>
                            </div>
                            <div class="menu-item" @click="navigateToPage('terminals')">
                                <span class="menu-icon">ğŸ’»</span>
                                <span class="menu-text">åœ¨çº¿ç»ˆç«¯</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§æœç´¢å’Œç»“æœåŒºåŸŸ -->
                <div class="right-panel">
                    <!-- æœç´¢åŒºåŸŸ -->
                    <div class="search-section">


                        <el-form :model="searchForm" class="search-form" :disabled="!selectedLog" @submit.prevent="executeSearch">
                            <!-- ä¸»æœç´¢æ¡†å®¹å™¨ -->
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="search-input-container" :class="{ focused: searchInputFocused }" style="flex: 1;">
                                    <input type="text" v-model="searchForm.keyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯ï¼Œç•™ç©ºåˆ™æ˜¾ç¤ºæœ€æ–°æ—¥å¿—"
                                        class="search-input" @focus="searchInputFocused = true"
                                        @blur="searchInputFocused = false" @keyup.enter="executeSearch"
                                        :disabled="!selectedLog" />

                                    <!-- æœç´¢è®¾ç½®æŒ‰é’®ç»„ -->
                                    <div class="search-buttons">
                                        <!-- æœç´¢æ¨¡å¼åˆ‡æ¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.search_mode === 'context' }"
                                            @click="toggleSearchMode" :disabled="!selectedLog" title="æœç´¢æ¨¡å¼">
                                            <span v-if="searchForm.search_mode === 'keyword'">âš¡</span>
                                            <span v-else>ğŸ“„</span>
                                        </button>

                                        <!-- æ­£åˆ™è¡¨è¾¾å¼ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.use_regex }"
                                            @click="searchForm.use_regex = !searchForm.use_regex" :disabled="!selectedLog"
                                            title="æ­£åˆ™è¡¨è¾¾å¼">
                                            .*
                                        </button>

                                        <!-- é€†åºæœç´¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.reverse_order }"
                                            @click="searchForm.reverse_order = !searchForm.reverse_order"
                                            :disabled="!selectedLog" title="é€†åºæœç´¢">
                                            <span v-if="searchForm.reverse_order">â¬†ï¸</span>
                                            <span v-else>â¬‡ï¸</span>
                                        </button>

                                        <!-- æŒ‡å®šæ–‡ä»¶æœç´¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.use_file_filter }" @click="toggleFileFilter"
                                            :disabled="!selectedLog" title="æŒ‡å®šæ–‡ä»¶æœç´¢">
                                            ğŸ“
                                        </button>

                                        <!-- ä¸Šä¸‹æ–‡è¡Œæ•° - åªåœ¨ä¸Šä¸‹æ–‡æ¨¡å¼æ—¶æ˜¾ç¤º -->
                                        <template v-if="searchForm.search_mode === 'context'">
                                            <span style="font-size: 12px; color: #909399; margin-left: 8px;">è¡Œæ•°:</span>
                                            <input type="number" v-model.number="searchForm.context_span"
                                                class="context-span-input" min="0" max="20" :disabled="!selectedLog"
                                                title="ä¸Šä¸‹æ–‡è¡Œæ•°" />
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- æœç´¢æŒ‰é’® - ç§»åˆ°å¤–é¢ -->
                                <button type="button" class="execute-search-btn" @click="executeSearch">
                                    æœç´¢
                                </button>
                            </div>

                            <!-- æ–‡ä»¶è¿‡æ»¤å™¨ (å¸¦è¿‡æ¸¡) -->
                            <transition name="file-filter" @after-enter="updateResultsHeight" @after-leave="updateResultsHeight">
                                <div v-if="searchForm.use_file_filter" style="margin-top:12px;">
                                    <div style="display:flex; gap:16px; flex-wrap:wrap;">
                                        <div v-for="group in groupedFiles" :key="group.host" style="flex:1; min-width:300px;">
                                            <div style="font-size:14px; font-weight:bold; color:#409eff; margin-bottom:8px; display:flex; align-items:center;">
                                                [[ group.host ]] ([[ group.files.length ]] ä¸ªæ–‡ä»¶)
                                            </div>
                                            <el-select v-model="searchForm.selected_files[group.host]" :placeholder="`é€‰æ‹© ${group.host} ä¸Šçš„æ–‡ä»¶`" size="default" filterable clearable :loading="filesLoading" style="width:100%;" :disabled="!selectedLog">
                                                <el-option v-for="fileItem in group.files" :key="fileItem.full_path" :label="fileItem.filename" :value="fileItem.full_path">
                                                    [[ fileItem.filename ]]
                                                </el-option>
                                            </el-select>
                                        </div>
                                    </div>
                                </div>
                            </transition>
                        </el-form>
                    </div>

                    <!-- æœç´¢ç»“æœåŒºåŸŸ -->
                    <div class="results-section" ref="resultsWrapper">

                        <!-- ä½¿ç”¨æ—¥å¿—æœç´¢ç»“æœç»„ä»¶ï¼ˆä»…åœ¨æœç´¢å®Œæˆåè¿›è¡Œé«˜äº®ï¼‰ -->
                        <log-search-results
                            :key="resultsVersion"
                            :search-results="searchResults"
                            :search-keyword="highlightKeyword"
                            :use-regex="searchForm.use_regex"
                            :height="searchResultsHeight"
                            :max-results="5000"
                            :show-search-stats="false"
                            :show-host-grouping="true"
                            :enabled-highlighters="effectiveHighlighters"
                            empty-message="æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•"
                        />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;

        const app = createApp({
            delimiters: ['[[', ']]'],
            components: {
                LogSearchResults
            },
            data() {
                return {
                    logs: [],
                    selectedLog: null,
                    logsLoading: false,
                    searching: false,
                    hasSearched: false,
                    resultsVersion: 0, // æ¯æ¬¡æœç´¢é€’å¢ä»¥é‡å»ºç»“æœç»„ä»¶ï¼Œé‡Šæ”¾å†…å­˜
                    highlightKeyword: '', // ä»…åœ¨æœç´¢å®Œæˆåç”¨äºé«˜äº®çš„å…³é”®è¯
                    searchInputFocused: false,
                    availableFiles: [], // å¯ç”¨æ–‡ä»¶åˆ—è¡¨
                    filesLoading: false, // æ–‡ä»¶åˆ—è¡¨åŠ è½½çŠ¶æ€
                    collapsedGroups: new Set(), // æŠ˜å çš„åˆ†ç»„
                    showMoreMenu: false, // æ›´å¤šèœå•æ˜¾ç¤ºçŠ¶æ€
                    dynamicResultsHeight: '400px', // åŠ¨æ€ç»“æœé«˜åº¦
                    searchForm: {
                        keyword: '',
                        search_mode: 'context', // keyword æˆ– context
                        context_span: 5,
                        use_regex: false,
                        reverse_order: false,
                        use_file_filter: false,
                        selected_file: '',  // ä¿æŒå‘åå…¼å®¹
                        selected_files: {}  // æ–°å¢ï¼šä¸»æœºåˆ°æ–‡ä»¶çš„æ˜ å°„
                    },
                    searchResults: null
                };
            },

            computed: {
                // æŒ‰åˆ†ç»„ç»„ç»‡çš„æ—¥å¿—åˆ—è¡¨
                groupedLogs() {
                    const groups = {};
                    this.logs.forEach(log => {
                        const groupName = log.group || 'é»˜è®¤åˆ†ç»„';
                        if (!groups[groupName]) {
                            groups[groupName] = [];
                        }
                        groups[groupName].push(log);
                    });

                    return Object.keys(groups).map(groupName => ({
                        name: groupName,
                        logs: groups[groupName].sort((a, b) => a.name.localeCompare(b.name)),
                        isCollapsed: this.collapsedGroups.has(groupName)
                    })).sort((a, b) => {
                        // é»˜è®¤åˆ†ç»„æ’åœ¨æœ€å
                        if (a.name === 'é»˜è®¤åˆ†ç»„' && b.name !== 'é»˜è®¤åˆ†ç»„') return 1;
                        if (b.name === 'é»˜è®¤åˆ†ç»„' && a.name !== 'é»˜è®¤åˆ†ç»„') return -1;
                        return a.name.localeCompare(b.name);
                    });
                },
                
                // æŒ‰ä¸»æœºåˆ†ç»„çš„æ–‡ä»¶åˆ—è¡¨
                groupedFiles() {
                    const groups = {};
                    this.availableFiles.forEach(file => {
                        const host = file.host || 'unknown';
                        if (!groups[host]) {
                            groups[host] = [];
                        }
                        groups[host].push(file);
                    });

                    return Object.keys(groups).map(host => ({
                        host: host,
                        files: groups[host].sort((a, b) => a.filename.localeCompare(b.filename))
                    }));
                },

                // é«˜äº®å™¨å¼€å…³ï¼šä»…åœ¨æœç´¢å®Œæˆåå¯ç”¨
                effectiveHighlighters() {
                    if (!this.hasSearched || this.searching || !this.searchResults) {
                        return {
                            logLevels: false,
                            timestamps: false,
                            network: false,
                            xml: false,
                            sql: false,
                            json: false,
                            filePaths: false,
                            urls: false,
                            emails: false,
                            uuids: false
                        };
                    }
                    return {
                        logLevels: true,
                        timestamps: true,
                        network: true,
                        xml: true,
                        sql: true,
                        json: true,
                        filePaths: true,
                        urls: true,
                        emails: true,
                        uuids: true
                    };
                },

                // ç»“æœé«˜åº¦ç”±æµ‹é‡é©±åŠ¨
                searchResultsHeight() { return this.dynamicResultsHeight; },

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶éƒ½å·²é€‰æ‹©
                isFileFilterValid() {
                    if (!this.searchForm.use_file_filter) {
                        return true; // å¦‚æœæ²¡æœ‰å¯ç”¨æ–‡ä»¶è¿‡æ»¤ï¼Œæ€»æ˜¯æœ‰æ•ˆ
                    }

                    // æ£€æŸ¥æ¯ä¸ªä¸»æœºæ˜¯å¦éƒ½é€‰æ‹©äº†æ–‡ä»¶
                    return this.groupedFiles.every(group =>
                        this.searchForm.selected_files[group.host]
                    );
                }
            },

            mounted() {
                this.loadLogs();

                // æ·»åŠ å…¨å±€å›è½¦é”®ç›‘å¬
                document.addEventListener('keydown', this.handleGlobalKeydown);
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•çš„ç›‘å¬
                document.addEventListener('click', this.handleClickOutside);

                // åˆæ¬¡è®¡ç®—é«˜åº¦
                this.$nextTick(() => this.updateResultsHeight());
                window.addEventListener('resize', this.updateResultsHeight, { passive: true });

                // å¦‚æœé€šè¿‡ç‹¬ç«‹é¡µé¢è¿›å…¥ (sftp / terminals / config)
                if (window.APP_PAGE && ['sftp','terminals','config'].includes(window.APP_PAGE)) {
                    // å»¶è¿Ÿè®©ç»„ä»¶åˆå§‹åŒ–å®Œæˆ
                    setTimeout(()=>{ this.navigateToPage(window.APP_PAGE); }, 300);
                }
            },

            beforeUnmount() {
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('keydown', this.handleGlobalKeydown);
                document.removeEventListener('click', this.handleClickOutside);
                window.removeEventListener('resize', this.updateResultsHeight);
            },

            methods: {
                // é€šç”¨é”™è¯¯å¤„ç†æ–¹æ³•
                handleApiError(error, defaultMessage = 'æ“ä½œå¤±è´¥') {
                    const errorInfo = error.response?.data?.error || error.error || {};
                    let errorMessage = defaultMessage;
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
                    switch (errorInfo.code) {
                        case 'VALIDATION_ERROR':
                            errorMessage = `å‚æ•°é”™è¯¯: ${errorInfo.message}`;
                            break;
                        case 'INVALID_CONTEXT_SPAN':
                            errorMessage = 'ä¸Šä¸‹æ–‡è¡Œæ•°è®¾ç½®æ— æ•ˆï¼Œè¯·è®¾ç½®ä¸º0-50ä¹‹é—´çš„æ•´æ•°';
                            break;
                        case 'INVALID_SEARCH_MODE':
                            errorMessage = 'æœç´¢æ¨¡å¼æ— æ•ˆï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„æœç´¢æ–¹å¼';
                            break;
                        case 'INVALID_FILE_FILTER':
                            errorMessage = 'æ–‡ä»¶è¿‡æ»¤è®¾ç½®æ— æ•ˆï¼Œå¯ç”¨è¿‡æ»¤æ—¶è¯·æŒ‡å®šè¦æœç´¢çš„æ–‡ä»¶';
                            break;
                        case 'CONNECTION_ERROR':
                            errorMessage = `è¿æ¥å¤±è´¥: ${errorInfo.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'}`;
                            break;
                        case 'DEADLINE_EXCEEDED':
                            errorMessage = `æ“ä½œè¶…æ—¶: ${errorInfo.message || 'è¯·ç¨åé‡è¯•'}`;
                            break;
                        case 'NOT_FOUND':
                            // é’ˆå¯¹ä¸åŒåœºæ™¯æä¾›æ›´å…·ä½“çš„é”™è¯¯æ¶ˆæ¯
                            if (defaultMessage.includes('æ—¥å¿—')) {
                                errorMessage = 'æ—¥å¿—é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆé…ç½®æ—¥å¿—';
                            } else {
                                errorMessage = errorInfo.message || 'èµ„æºä¸å­˜åœ¨';
                            }
                            break;
                        case 'PERMISSION_DENIED':
                            // é’ˆå¯¹ä¸åŒåœºæ™¯æä¾›æ›´å…·ä½“çš„é”™è¯¯æ¶ˆæ¯
                            if (defaultMessage.includes('æ—¥å¿—')) {
                                errorMessage = 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ—¥å¿—é…ç½®';
                            } else if (defaultMessage.includes('æ–‡ä»¶')) {
                                errorMessage = 'æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ–‡ä»¶åˆ—è¡¨';
                            } else {
                                errorMessage = `æƒé™ä¸è¶³: ${errorInfo.message || 'è¯·è”ç³»ç®¡ç†å‘˜'}`;
                            }
                            break;
                        case 'INTERNAL':
                            errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                            break;
                        default:
                            errorMessage = errorInfo.message || defaultMessage;
                    }
                    
                    ElMessage.error(errorMessage);
                    
                    // å¦‚æœæ˜¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    if (errorInfo.details) {
                        console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', errorInfo.details);
                    }
                },

                // å…¨å±€é”®ç›˜äº‹ä»¶å¤„ç†
                handleGlobalKeydown(event) {
                    // æŒ‰ä¸‹å›è½¦é”®ä¸”ä¸åœ¨è¾“å…¥æ¡†ã€æ–‡æœ¬åŸŸæˆ–å…¶ä»–å¯ç¼–è¾‘å…ƒç´ ä¸­
                    if (event.key === 'Enter' &&
                        !['INPUT', 'TEXTAREA'].includes(event.target.tagName) &&
                        !event.target.isContentEditable) {

                        // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                        event.preventDefault();
                        event.stopPropagation();

                        // æ‰§è¡Œæœç´¢
                        this.executeSearch();
                    }
                    
                    // æŒ‰ESCé”®å…³é—­æ›´å¤šèœå•
                    if (event.key === 'Escape' && this.showMoreMenu) {
                        this.showMoreMenu = false;
                    }
                },

                // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
                handleClickOutside(event) {
                    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æ›´å¤šæŒ‰é’®åŒºåŸŸå¤–
                    const moreActions = event.target.closest('.more-actions');
                    if (!moreActions && this.showMoreMenu) {
                        this.showMoreMenu = false;
                    }
                },

                // åˆ†ç»„æŠ˜å /å±•å¼€æ§åˆ¶
                toggleGroup(groupName) {
                    if (this.collapsedGroups.has(groupName)) {
                        this.collapsedGroups.delete(groupName);
                    } else {
                        this.collapsedGroups.add(groupName);
                    }
                },

                // åˆ‡æ¢æ›´å¤šèœå•æ˜¾ç¤ºçŠ¶æ€
                toggleMoreMenu() {
                    this.showMoreMenu = !this.showMoreMenu;
                },

                // é¡µé¢å¯¼èˆª
                navigateToPage(page) {
                    this.showMoreMenu = false; // å…³é—­èœå•
                    
                    // é¡µé¢é…ç½®
                    const pageConfig = {
                        'config': {
                            url: '/config',
                            title: 'æ—¥å¿—é…ç½®',
                            icon: 'âš™ï¸'
                        },
                        'sftp': {
                            url: '/sftp',
                            title: 'æ–‡ä»¶ç®¡ç†',
                            icon: 'ğŸ“'
                        },
                        'terminals': {
                            url: '/terminals',
                            title: 'åœ¨çº¿ç»ˆç«¯',
                            icon: 'ğŸ’»'
                        }
                    };
                    
                    const config = pageConfig[page];
                    if (config) {
                        // æ˜¾ç¤ºå¯¼èˆªæç¤º
                        ElMessage.info(`æ­£åœ¨æ‰“å¼€ ${config.icon} ${config.title}...`);
                        
                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†æ‰“å¼€ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                        setTimeout(() => {
                            // å¯ä»¥é€‰æ‹©åœ¨æ–°çª—å£æ‰“å¼€æˆ–å½“å‰çª—å£è·³è½¬
                            // æ–°çª—å£æ‰“å¼€ï¼ˆæ¨èï¼‰
                            window.open(config.url, '_blank');
                            
                            // å¦‚æœè¦åœ¨å½“å‰çª—å£è·³è½¬ï¼Œä½¿ç”¨ï¼š
                            // window.location.href = config.url;
                        }, 300);
                    } else {
                        ElMessage.warning(`åŠŸèƒ½ ${page} æš‚æœªå¼€æ”¾`);
                    }
                },

                async loadLogs() {
                    this.logsLoading = true;
                    try {
                        const response = await axios.get('/api/v1/logs');
                        if (response.data.success) {
                            this.logs = response.data.data.logs || [];
                            // é»˜è®¤æŠ˜å æ‰€æœ‰åˆ†ç»„
                            this.collapsedGroups.clear();
                            const groups = new Set();
                            this.logs.forEach(log => {
                                const groupName = log.group || 'é»˜è®¤åˆ†ç»„';
                                groups.add(groupName);
                            });
                            groups.forEach(groupName => {
                                this.collapsedGroups.add(groupName);
                            });
                        } else {
                            this.handleApiError({ response: { data: response.data } }, 'åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥');
                        }
                    } catch (error) {
                        this.handleApiError(error, 'è¿æ¥æœåŠ¡å™¨å¤±è´¥');
                        console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                    } finally {
                        this.logsLoading = false;
                    }
                },

                selectLog(log) {
                    this.selectedLog = log;
                    this.searchResults = null;
                    this.hasSearched = false;
                    this.highlightKeyword = '';

                    // åªæ¸…ç†æ–‡ä»¶é€‰æ‹©ï¼Œä¿æŒæœç´¢å…³é”®è¯å’Œæœç´¢è®¾ç½®
                    this.searchForm.selected_file = '';
                    this.searchForm.selected_files = {};

                    // å¦‚æœæ–‡ä»¶è¿‡æ»¤å·²å¯ç”¨ï¼Œè‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨
                    if (this.searchForm.use_file_filter) {
                        this.loadAvailableFiles();
                    }
                },

                // åˆ‡æ¢æœç´¢æ¨¡å¼
                toggleSearchMode() {
                    this.searchForm.search_mode = this.searchForm.search_mode === 'keyword' ? 'context' : 'keyword';
                    const mode = this.searchForm.search_mode === 'keyword' ? 'å…³é”®è¯æœç´¢' : 'ä¸Šä¸‹æ–‡æœç´¢';
                    ElMessage.info(`å·²åˆ‡æ¢åˆ°${mode}æ¨¡å¼`);
                },

                // åˆ‡æ¢æ–‡ä»¶è¿‡æ»¤
                toggleFileFilter() {
                    this.searchForm.use_file_filter = !this.searchForm.use_file_filter;
                    if (this.searchForm.use_file_filter) {
                        ElMessage.info('å·²å¯ç”¨æ–‡ä»¶è¿‡æ»¤ï¼Œæ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...');
                        this.loadAvailableFiles();
                    } else {
                        this.searchForm.selected_file = '';
                        this.searchForm.selected_files = {};
                        this.availableFiles = [];
                        ElMessage.info('å·²å…³é—­æ–‡ä»¶è¿‡æ»¤');
                    }
                    this.$nextTick(() => this.updateResultsHeight());
                },

                // åŠ è½½å¯ç”¨æ–‡ä»¶åˆ—è¡¨
                async loadAvailableFiles() {
                    if (!this.selectedLog) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥å¿—é…ç½®');
                        return;
                    }

                    this.filesLoading = true;
                    try {
                        const response = await axios.get(`/api/v1/logs/${this.selectedLog.name}/files`);
                        if (response.data.success) {
                            this.availableFiles = response.data.data.files || [];
                            ElMessage.success(`åŠ è½½äº† ${this.availableFiles.length} ä¸ªæ–‡ä»¶`);
                            this.$nextTick(() => this.updateResultsHeight());
                        } else {
                            this.handleApiError({ response: { data: response.data } }, 'åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                            this.availableFiles = [];
                        }
                    } catch (error) {
                        this.handleApiError(error, 'åŠ è½½æ–‡ä»¶åˆ—è¡¨è¯·æ±‚å¤±è´¥');
                        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        this.availableFiles = [];
                    } finally {
                        this.filesLoading = false;
                    }
                },

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
                formatFileSize(bytes) {
                    if (!bytes || bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                // æ ¼å¼åŒ–æ–‡ä»¶æ—¶é—´æ˜¾ç¤º
                formatFileTime(timeStr) {
                    if (!timeStr) return 'æœªçŸ¥';
                    try {
                        const date = new Date(timeStr);
                        // è¿”å›æ ‡å‡†æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                    } catch (e) {
                        return timeStr;
                    }
                },

                async executeSearch() {
                    if (!this.selectedLog) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥å¿—é…ç½®');
                        return;
                    }

                    // éªŒè¯æ–‡ä»¶è¿‡æ»¤è®¾ç½®
                    if (this.searchForm.use_file_filter) {
                        const missingHosts = [];
                        this.groupedFiles.forEach(group => {
                            if (!this.searchForm.selected_files[group.host]) {
                                missingHosts.push(group.host);
                            }
                        });

                        if (missingHosts.length > 0) {
                            ElMessage.error(`è¯·ä¸ºä»¥ä¸‹ä¸»æœºé€‰æ‹©æ–‡ä»¶: ${missingHosts.join(', ')}`);
                            return;
                        }
                    }

                    // æ¸…ç©ºä¸Šä¸€æ¬¡æœç´¢å ç”¨çš„å†…å­˜ï¼š
                    // 1) æ–­å¼€å¯¹æ—§ç»“æœçš„å¼•ç”¨
                    this.searchResults = null;
                    this.highlightKeyword = '';
                    // 2) é€’å¢ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶å¸è½½å¹¶é‡å»ºç»“æœç»„ä»¶ï¼Œé‡Šæ”¾æ—§DOM
                    this.resultsVersion += 1;
                    await this.$nextTick();

                    this.searching = true;
                    this.hasSearched = true;

                    try {
                        const response = await axios.post(
                            `/api/v1/logs/${this.selectedLog.name}/search`,
                            this.searchForm
                        );

                        if (response.data.success) {
                            this.searchResults = response.data.data;
                            // æœç´¢å®Œæˆåæ‰æ›´æ–°é«˜äº®å…³é”®è¯
                            this.highlightKeyword = this.searchForm.keyword || '';
                            if (this.searchResults.total_matches === 0) {
                                ElMessage.info('æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•');
                            } else {
                                ElMessage.success(`æ‰¾åˆ° ${this.searchResults.total_matches} ä¸ªåŒ¹é…é¡¹`);
                            }
                        } else {
                            this.handleApiError({ response: { data: response.data } }, 'æœç´¢å¤±è´¥');
                            this.searchResults = null;
                            this.highlightKeyword = '';
                        }
                    } catch (error) {
                        this.handleApiError(error, 'æœç´¢è¯·æ±‚å¤±è´¥');
                        console.error('æœç´¢å¤±è´¥:', error);
                        this.searchResults = null;
                        this.highlightKeyword = '';
                    } finally {
                        this.searching = false;
                        this.$nextTick(() => this.updateResultsHeight());
                    }
                }
                ,
                updateResultsHeight() {
                    try {
                        const wrapper = this.$refs.resultsWrapper;
                        if (!wrapper) return;
                        const wrapperRect = wrapper.getBoundingClientRect();
                        // ä»¥ right-panel å®¹å™¨åº•éƒ¨ä¸ºç•Œé™ï¼ˆé¿å…çª—å£å†…å…¶å®ƒ padding å½±å“ï¼‰
                        const parentPanel = wrapper.closest('.right-panel');
                        let availableHeight;
                        if (parentPanel) {
                            const panelRect = parentPanel.getBoundingClientRect();
                            // ç•™å‡ºä¸åº•éƒ¨ç»Ÿä¸€é—´è·
                            const bottomGap = 16;
                            // å‡å»è‡ªèº« padding-bottomï¼Œé˜²æ­¢æ’‘å‡ºçˆ¶å®¹å™¨
                            const wrapperStyles = window.getComputedStyle(wrapper);
                            const paddingBottom = parseInt(wrapperStyles.paddingBottom) || 0;
                            availableHeight = panelRect.bottom - wrapperRect.top - bottomGap - paddingBottom;
                        } else {
                            const bottomGap = 16;
                            availableHeight = window.innerHeight - wrapperRect.top - bottomGap;
                        }
                        // å‡å»å¤´éƒ¨é«˜åº¦ï¼ˆæ ‡é¢˜ä¸ç»Ÿè®¡æ ‡ç­¾åŒºåŸŸï¼‰
                        const headerEl = wrapper.querySelector('.results-section-header');
                        let headerH = 0;
                        if (headerEl) {
                            const hr = headerEl.getBoundingClientRect();
                            headerH = hr.height + 4; // é¢å¤–ç•™ 4px é—´è·
                        }
                        availableHeight -= headerH;
                        if (availableHeight < 120) availableHeight = 120; // ä¿åº•
                        // è‹¥æœ‰æ–‡ä»¶è¿‡æ»¤å™¨å¤„äºå±•å¼€çŠ¶æ€ï¼Œå…¶åŠ¨ç”»å¯èƒ½å°šæœªç»“æŸï¼Œç¨åšè¡¥å¿å†æ¬¡åˆ·æ–°
                        const minH = 200;
                        this.dynamicResultsHeight = Math.max(minH, availableHeight) + 'px';
                        // åŠ¨ç”»è¿‡ç¨‹ä¸­å†æ¬¡æµ‹é‡ï¼ˆé¿å…é¦–æ¬¡é«˜åº¦ç®—å¤§/ç®—å°ï¼‰
                        requestAnimationFrame(() => {
                            const w2 = this.$refs.resultsWrapper;
                            if (!w2) return;
                            const wr2 = w2.getBoundingClientRect();
                            const pp2 = w2.closest('.right-panel');
                            if (pp2) {
                                const pr2 = pp2.getBoundingClientRect();
                                const gap = 16;
                                const w2Styles = window.getComputedStyle(w2);
                                const padB2 = parseInt(w2Styles.paddingBottom) || 0;
                                const avail2 = pr2.bottom - wr2.top - gap - padB2;
                                const header2 = w2.querySelector('.results-section-header');
                                if (header2) {
                                    const h2 = header2.getBoundingClientRect().height + 4;
                                    avail2 -= h2;
                                }
                                this.dynamicResultsHeight = Math.max(minH, avail2) + 'px';
                            }
                        });
                    } catch(e) { /* ignore */ }
                }
            }
        });

        // ä½¿ç”¨ Element Plus å’Œå…¶æŒ‡ä»¤
        app.use(ElementPlus);

        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
    </script>
</body>

</html>