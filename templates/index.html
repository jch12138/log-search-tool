<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—æœç´¢ç³»ç»Ÿ</title>

    <!-- æœ¬åœ°èµ„æº -->
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="/static/css/element-plus.css" />
    <!-- Prism.js CSSä¸»é¢˜ -->
    <link rel="stylesheet" href="/static/css/prism-okaidia.min.css" />
    <!-- è‡ªå®šä¹‰CSS -->
    <link rel="stylesheet" href="/static/fonts/microsoft-yahei.css" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/groups.css" />
    <link rel="stylesheet" href="/static/css/search.css" />
    <link rel="stylesheet" href="/static/css/results.css" />
    
    <!-- æœ¬åœ°JavaScriptåº“ -->
    <script src="/static/js/vendor/vue.global.js"></script>
    <script src="/static/js/vendor/element-plus.js"></script>
    <script src="/static/js/vendor/axios.min.js"></script>
    <!-- Prism.jsåº“ -->
    <script src="/static/js/vendor/prism-core.min.js"></script>
    <script src="/static/js/vendor/prism-markup.min.js"></script>
    <script src="/static/js/vendor/prism-clike.min.js"></script>
    <script src="/static/js/vendor/prism-javascript.min.js"></script>
    <script src="/static/js/vendor/prism-json.min.js"></script>
    <script src="/static/js/vendor/prism-sql.min.js"></script>
    <script src="/static/js/vendor/prism-xml-doc.min.js"></script>
    <!-- LogSearchResults ç»„ä»¶ -->
    <script src="/static/js/LogSearchResults.js"></script>

</head>

<body>
    <div id="app">
        <div class="app-container">


            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- å·¦ä¾§æ—¥å¿—åˆ—è¡¨ -->
                <div class="left-panel">
                    <div class="panel-header">
                        <h3>ğŸ” æ—¥å¿—èšåˆæœç´¢</h3>
                    </div>
                    <div class="log-list" v-loading="logsLoading">
                        <div v-if="logs.length === 0 && !logsLoading" class="empty-state">
                            <div>æš‚æ— æ—¥å¿—é…ç½®</div>
                        </div>
                        
                        <!-- åˆ†ç»„æ˜¾ç¤º -->
                        <div v-for="group in groupedLogs" :key="group.name" class="log-group">
                            <!-- åˆ†ç»„æ ‡é¢˜ -->
                            <div class="group-header" @click="toggleGroup(group.name)">
                                <span class="group-name">[[ group.name ]]</span>
                                <span class="group-count">([[ group.logs.length ]])</span>
                                <span class="toggle-icon" :class="{ collapsed: group.isCollapsed }">â–¼</span>
                            </div>
                            
                            <!-- åˆ†ç»„å†…çš„æ—¥å¿—åˆ—è¡¨ -->
                            <div v-show="!group.isCollapsed" class="group-content">
                                <div v-for="log in group.logs" :key="log.name" class="log-item"
                                    :class="{ active: selectedLog?.name === log.name }" @click="selectLog(log)">
                                    <h4>[[ log.name ]]</h4>
                                    <p>[[ log.description || 'æš‚æ— æè¿°' ]]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ›´å¤šåŠŸèƒ½æŒ‰é’® -->
                    <div class="more-actions">
                        <button class="more-button" @click="toggleMoreMenu" :class="{ active: showMoreMenu }">
                            <span class="more-icon">âš™ï¸</span>
                            <span class="more-text">æ›´å¤šåŠŸèƒ½</span>
                            <span class="arrow-icon" :class="{ rotated: showMoreMenu }">â–¼</span>
                        </button>
                        
                        <!-- æ›´å¤šåŠŸèƒ½èœå• -->
                        <div v-show="showMoreMenu" class="more-menu">
                            <div class="menu-item" @click="navigateToPage('config')">
                                <span class="menu-icon">âš™ï¸</span>
                                <span class="menu-text">æ—¥å¿—é…ç½®</span>
                            </div>
                            <div class="menu-item" @click="navigateToPage('sftp')">
                                <span class="menu-icon">ğŸ“</span>
                                <span class="menu-text">æ–‡ä»¶ç®¡ç†</span>
                            </div>
                            <div class="menu-item" @click="navigateToPage('terminals')">
                                <span class="menu-icon">ğŸ’»</span>
                                <span class="menu-text">åœ¨çº¿ç»ˆç«¯</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§æœç´¢å’Œç»“æœåŒºåŸŸ -->
                <div class="right-panel">
                    <!-- æœç´¢åŒºåŸŸ -->
                    <div class="search-section">


                        <el-form :model="searchForm" class="search-form" :disabled="!selectedLog" @submit.prevent="executeSearch">
                            <!-- ä¸»æœç´¢æ¡†å®¹å™¨ -->
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="search-input-container" :class="{ focused: searchInputFocused }" style="flex: 1;">
                                    <input type="text" v-model="searchForm.keyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯ï¼Œç•™ç©ºåˆ™æ˜¾ç¤ºæœ€æ–°æ—¥å¿—"
                                        class="search-input" @focus="searchInputFocused = true"
                                        @blur="searchInputFocused = false" @keyup.enter="executeSearch"
                                        :disabled="!selectedLog" />

                                    <!-- æœç´¢è®¾ç½®æŒ‰é’®ç»„ -->
                                    <div class="search-buttons">
                                        <!-- æœç´¢æ¨¡å¼åˆ‡æ¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.search_mode === 'context' }"
                                            @click="toggleSearchMode" :disabled="!selectedLog" title="æœç´¢æ¨¡å¼">
                                            <span v-if="searchForm.search_mode === 'keyword'">âš¡</span>
                                            <span v-else>ğŸ“„</span>
                                        </button>

                                        <!-- æ­£åˆ™è¡¨è¾¾å¼ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.use_regex }"
                                            @click="searchForm.use_regex = !searchForm.use_regex" :disabled="!selectedLog"
                                            title="æ­£åˆ™è¡¨è¾¾å¼">
                                            .*
                                        </button>

                                        <!-- é€†åºæœç´¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.reverse_order }"
                                            @click="searchForm.reverse_order = !searchForm.reverse_order"
                                            :disabled="!selectedLog" title="é€†åºæœç´¢">
                                            <span v-if="searchForm.reverse_order">â¬†ï¸</span>
                                            <span v-else>â¬‡ï¸</span>
                                        </button>

                                        <!-- æŒ‡å®šæ–‡ä»¶æœç´¢ -->
                                        <button type="button" class="search-button"
                                            :class="{ active: searchForm.use_file_filter }" @click="toggleFileFilter"
                                            :disabled="!selectedLog" title="æŒ‡å®šæ–‡ä»¶æœç´¢">
                                            ğŸ“
                                        </button>

                                        <!-- ä¸Šä¸‹æ–‡è¡Œæ•° - åªåœ¨ä¸Šä¸‹æ–‡æ¨¡å¼æ—¶æ˜¾ç¤º -->
                                        <template v-if="searchForm.search_mode === 'context'">
                                            <span style="font-size: 12px; color: #909399; margin-left: 8px;">è¡Œæ•°:</span>
                                            <input type="number" v-model.number="searchForm.context_span"
                                                class="context-span-input" min="0" max="20" :disabled="!selectedLog"
                                                title="ä¸Šä¸‹æ–‡è¡Œæ•°" />
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- æœç´¢æŒ‰é’® - ç§»åˆ°å¤–é¢ -->
                                <button type="button" class="execute-search-btn" @click="executeSearch">
                                    æœç´¢
                                </button>
                            </div>

                            <!-- æ–‡ä»¶è¿‡æ»¤å™¨ (å½“å¯ç”¨æŒ‡å®šæ–‡ä»¶æœç´¢æ—¶æ˜¾ç¤º) -->
                            <div v-if="searchForm.use_file_filter" style="margin-top: 12px;">
                                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                    <div v-for="group in groupedFiles" :key="group.host"
                                        style="flex: 1; min-width: 300px;">
                                        <div
                                            style="font-size: 14px; font-weight: bold; color: #409eff; margin-bottom: 8px; display: flex; align-items: center;">
                                            [[ group.host ]] ([[ group.files.length ]] ä¸ªæ–‡ä»¶)
                                        </div>
                                        <el-select v-model="searchForm.selected_files[group.host]"
                                            :placeholder="`é€‰æ‹© ${group.host} ä¸Šçš„æ–‡ä»¶`" size="default" filterable clearable
                                            :loading="filesLoading" style="width: 100%;" :disabled="!selectedLog">
                                            <el-option v-for="fileItem in group.files" :key="fileItem.full_path"
                                                :label="fileItem.filename" :value="fileItem.full_path">
                                                [[ fileItem.filename ]]
                                            </el-option>
                                        </el-select>
                                    </div>
                                </div>
                            </div>
                        </el-form>
                    </div>

                    <!-- æœç´¢ç»“æœåŒºåŸŸ -->
                    <div class="results-section">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #303133;">æœç´¢ç»“æœ</h3>
                            <div v-if="searchResults && searchResults.total_matches > 0"
                                style="margin-left: 16px; display: flex; align-items: center; gap: 8px;">
                                <span class="el-tag el-tag--info el-tag--small">
                                    å…±æ‰¾åˆ° [[ searchResults.total_matches ]] ä¸ªåŒ¹é…é¡¹
                                </span>
                                <span class="el-tag el-tag--success el-tag--small">
                                    æœç´¢è€—æ—¶: [[ Number(searchResults.search_time).toFixed(3) ]]s
                                </span>
                                <span class="el-tag el-tag--warning el-tag--small">
                                    ä¸»æœºæ•°: [[ searchResults.hosts_searched ]]
                                </span>
                            </div>
                        </div>

                        <!-- ä½¿ç”¨æ—¥å¿—æœç´¢ç»“æœç»„ä»¶ -->
                        <log-search-results :search-results="searchResults" :search-keyword="searchForm.keyword"
                            :use-regex="searchForm.use_regex" :height="searchResultsHeight" :max-results="5000"
                            :show-search-stats="false" :show-host-grouping="true" :enabled-highlighters="{
                                logLevels: true,
                                timestamps: true,
                                network: true,
                                xml: true,
                                sql: true,
                                json: true,
                                filePaths: true,
                                urls: true,
                                emails: true,
                                uuids: true
                            }" empty-message="æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;

        const app = createApp({
            delimiters: ['[[', ']]'],
            components: {
                LogSearchResults
            },
            data() {
                return {
                    logs: [],
                    selectedLog: null,
                    logsLoading: false,
                    searching: false,
                    hasSearched: false,
                    searchInputFocused: false,
                    availableFiles: [], // å¯ç”¨æ–‡ä»¶åˆ—è¡¨
                    filesLoading: false, // æ–‡ä»¶åˆ—è¡¨åŠ è½½çŠ¶æ€
                    collapsedGroups: new Set(), // æŠ˜å çš„åˆ†ç»„
                    showMoreMenu: false, // æ›´å¤šèœå•æ˜¾ç¤ºçŠ¶æ€
                    searchForm: {
                        keyword: '',
                        search_mode: 'keyword', // keyword æˆ– context
                        context_span: 5,
                        use_regex: false,
                        reverse_order: false,
                        use_file_filter: false,
                        selected_file: '',  // ä¿æŒå‘åå…¼å®¹
                        selected_files: {}  // æ–°å¢ï¼šä¸»æœºåˆ°æ–‡ä»¶çš„æ˜ å°„
                    },
                    searchResults: null
                };
            },

            computed: {
                // æŒ‰åˆ†ç»„ç»„ç»‡çš„æ—¥å¿—åˆ—è¡¨
                groupedLogs() {
                    const groups = {};
                    this.logs.forEach(log => {
                        const groupName = log.group || 'é»˜è®¤åˆ†ç»„';
                        if (!groups[groupName]) {
                            groups[groupName] = [];
                        }
                        groups[groupName].push(log);
                    });

                    return Object.keys(groups).map(groupName => ({
                        name: groupName,
                        logs: groups[groupName].sort((a, b) => a.name.localeCompare(b.name)),
                        isCollapsed: this.collapsedGroups.has(groupName)
                    })).sort((a, b) => {
                        // é»˜è®¤åˆ†ç»„æ’åœ¨æœ€å
                        if (a.name === 'é»˜è®¤åˆ†ç»„' && b.name !== 'é»˜è®¤åˆ†ç»„') return 1;
                        if (b.name === 'é»˜è®¤åˆ†ç»„' && a.name !== 'é»˜è®¤åˆ†ç»„') return -1;
                        return a.name.localeCompare(b.name);
                    });
                },
                
                // æŒ‰ä¸»æœºåˆ†ç»„çš„æ–‡ä»¶åˆ—è¡¨
                groupedFiles() {
                    const groups = {};
                    this.availableFiles.forEach(file => {
                        const host = file.host || 'unknown';
                        if (!groups[host]) {
                            groups[host] = [];
                        }
                        groups[host].push(file);
                    });

                    return Object.keys(groups).map(host => ({
                        host: host,
                        files: groups[host].sort((a, b) => a.filename.localeCompare(b.filename))
                    }));
                },

                // åŠ¨æ€è®¡ç®—æœç´¢ç»“æœæ¡†é«˜åº¦
                searchResultsHeight() {
                    // åŸºç¡€é«˜åº¦ï¼š100vh - é¡¶éƒ¨å›ºå®šåŒºåŸŸé«˜åº¦
                    let baseOffset = 220;

                    // å¦‚æœå¯ç”¨äº†æ–‡ä»¶è¿‡æ»¤ï¼Œéœ€è¦é¢å¤–å‡å»æ–‡ä»¶è¿‡æ»¤å™¨çš„é«˜åº¦
                    if (this.searchForm.use_file_filter && this.groupedFiles.length > 0) {
                        // æ¯ä¸ªä¸»æœºè¡Œå¤§çº¦80pxï¼ˆæ ‡é¢˜+ä¸‹æ‹‰æ¡†+é—´è·ï¼‰
                        const filterHeight = this.groupedFiles.length * 40 + 20; // 20pxé¢å¤–é—´è·
                        baseOffset += filterHeight;
                    }

                    return `calc(100vh - ${baseOffset}px)`;
                },

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶éƒ½å·²é€‰æ‹©
                isFileFilterValid() {
                    if (!this.searchForm.use_file_filter) {
                        return true; // å¦‚æœæ²¡æœ‰å¯ç”¨æ–‡ä»¶è¿‡æ»¤ï¼Œæ€»æ˜¯æœ‰æ•ˆ
                    }

                    // æ£€æŸ¥æ¯ä¸ªä¸»æœºæ˜¯å¦éƒ½é€‰æ‹©äº†æ–‡ä»¶
                    return this.groupedFiles.every(group =>
                        this.searchForm.selected_files[group.host]
                    );
                }
            },

            mounted() {
                this.loadLogs();

                // æ·»åŠ å…¨å±€å›è½¦é”®ç›‘å¬
                document.addEventListener('keydown', this.handleGlobalKeydown);
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•çš„ç›‘å¬
                document.addEventListener('click', this.handleClickOutside);
            },

            beforeUnmount() {
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('keydown', this.handleGlobalKeydown);
                document.removeEventListener('click', this.handleClickOutside);
            },

            methods: {
                // å…¨å±€é”®ç›˜äº‹ä»¶å¤„ç†
                handleGlobalKeydown(event) {
                    // æŒ‰ä¸‹å›è½¦é”®ä¸”ä¸åœ¨è¾“å…¥æ¡†ã€æ–‡æœ¬åŸŸæˆ–å…¶ä»–å¯ç¼–è¾‘å…ƒç´ ä¸­
                    if (event.key === 'Enter' &&
                        !['INPUT', 'TEXTAREA'].includes(event.target.tagName) &&
                        !event.target.isContentEditable) {

                        // é˜²æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                        event.preventDefault();
                        event.stopPropagation();

                        // æ‰§è¡Œæœç´¢
                        this.executeSearch();
                    }
                    
                    // æŒ‰ESCé”®å…³é—­æ›´å¤šèœå•
                    if (event.key === 'Escape' && this.showMoreMenu) {
                        this.showMoreMenu = false;
                    }
                },

                // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
                handleClickOutside(event) {
                    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æ›´å¤šæŒ‰é’®åŒºåŸŸå¤–
                    const moreActions = event.target.closest('.more-actions');
                    if (!moreActions && this.showMoreMenu) {
                        this.showMoreMenu = false;
                    }
                },

                // åˆ†ç»„æŠ˜å /å±•å¼€æ§åˆ¶
                toggleGroup(groupName) {
                    if (this.collapsedGroups.has(groupName)) {
                        this.collapsedGroups.delete(groupName);
                    } else {
                        this.collapsedGroups.add(groupName);
                    }
                },

                // åˆ‡æ¢æ›´å¤šèœå•æ˜¾ç¤ºçŠ¶æ€
                toggleMoreMenu() {
                    this.showMoreMenu = !this.showMoreMenu;
                },

                // é¡µé¢å¯¼èˆª
                navigateToPage(page) {
                    this.showMoreMenu = false; // å…³é—­èœå•
                    
                    // é¡µé¢é…ç½®
                    const pageConfig = {
                        'config': {
                            url: '/config',
                            title: 'æ—¥å¿—é…ç½®',
                            icon: 'âš™ï¸'
                        },
                        'sftp': {
                            url: '/sftp',
                            title: 'æ–‡ä»¶ç®¡ç†',
                            icon: 'ï¿½'
                        },
                        'terminals': {
                            url: '/terminals',
                            title: 'åœ¨çº¿ç»ˆç«¯',
                            icon: 'ğŸ’»'
                        }
                    };
                    
                    const config = pageConfig[page];
                    if (config) {
                        // æ˜¾ç¤ºå¯¼èˆªæç¤º
                        ElMessage.info(`æ­£åœ¨æ‰“å¼€ ${config.icon} ${config.title}...`);
                        
                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†æ‰“å¼€ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                        setTimeout(() => {
                            // å¯ä»¥é€‰æ‹©åœ¨æ–°çª—å£æ‰“å¼€æˆ–å½“å‰çª—å£è·³è½¬
                            // æ–°çª—å£æ‰“å¼€ï¼ˆæ¨èï¼‰
                            window.open(config.url, '_blank');
                            
                            // å¦‚æœè¦åœ¨å½“å‰çª—å£è·³è½¬ï¼Œä½¿ç”¨ï¼š
                            // window.location.href = config.url;
                        }, 300);
                    } else {
                        ElMessage.warning(`åŠŸèƒ½ ${page} æš‚æœªå¼€æ”¾`);
                    }
                },

                async loadLogs() {
                    this.logsLoading = true;
                    try {
                        const response = await axios.get('/api/v1/logs');
                        if (response.data.success) {
                            this.logs = response.data.data.logs || [];
                        } else {
                            ElMessage.error('åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥: ' + (response.data.error?.message || 'æœªçŸ¥é”™è¯¯'));
                        }
                    } catch (error) {
                        ElMessage.error('è¿æ¥æœåŠ¡å™¨å¤±è´¥: ' + error.message);
                        console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                    } finally {
                        this.logsLoading = false;
                    }
                },

                selectLog(log) {
                    this.selectedLog = log;
                    this.searchResults = null;
                    this.hasSearched = false;

                    // åªæ¸…ç†æ–‡ä»¶é€‰æ‹©ï¼Œä¿æŒæœç´¢å…³é”®è¯å’Œæœç´¢è®¾ç½®
                    this.searchForm.selected_file = '';
                    this.searchForm.selected_files = {};

                    // å¦‚æœæ–‡ä»¶è¿‡æ»¤å·²å¯ç”¨ï¼Œè‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨
                    if (this.searchForm.use_file_filter) {
                        this.loadAvailableFiles();
                    }
                },

                // åˆ‡æ¢æœç´¢æ¨¡å¼
                toggleSearchMode() {
                    this.searchForm.search_mode = this.searchForm.search_mode === 'keyword' ? 'context' : 'keyword';
                    const mode = this.searchForm.search_mode === 'keyword' ? 'å…³é”®è¯æœç´¢' : 'ä¸Šä¸‹æ–‡æœç´¢';
                    ElMessage.info(`å·²åˆ‡æ¢åˆ°${mode}æ¨¡å¼`);
                },

                // åˆ‡æ¢æ–‡ä»¶è¿‡æ»¤
                toggleFileFilter() {
                    this.searchForm.use_file_filter = !this.searchForm.use_file_filter;
                    if (this.searchForm.use_file_filter) {
                        ElMessage.info('å·²å¯ç”¨æ–‡ä»¶è¿‡æ»¤ï¼Œæ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...');
                        this.loadAvailableFiles();
                    } else {
                        this.searchForm.selected_file = '';
                        this.searchForm.selected_files = {};
                        this.availableFiles = [];
                        ElMessage.info('å·²å…³é—­æ–‡ä»¶è¿‡æ»¤');
                    }
                },

                // åŠ è½½å¯ç”¨æ–‡ä»¶åˆ—è¡¨
                async loadAvailableFiles() {
                    if (!this.selectedLog) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥å¿—é…ç½®');
                        return;
                    }

                    this.filesLoading = true;
                    try {
                        const response = await axios.get(`/api/v1/logs/${this.selectedLog.name}/files`);
                        if (response.data.success) {
                            this.availableFiles = response.data.data.files || [];
                            ElMessage.success(`åŠ è½½äº† ${this.availableFiles.length} ä¸ªæ–‡ä»¶`);
                        } else {
                            ElMessage.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + (response.data.error?.message || 'æœªçŸ¥é”™è¯¯'));
                            this.availableFiles = [];
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨è¯·æ±‚å¤±è´¥: ' + error.message);
                        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        this.availableFiles = [];
                    } finally {
                        this.filesLoading = false;
                    }
                },

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
                formatFileSize(bytes) {
                    if (!bytes || bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                // æ ¼å¼åŒ–æ–‡ä»¶æ—¶é—´æ˜¾ç¤º
                formatFileTime(timeStr) {
                    if (!timeStr) return 'æœªçŸ¥';
                    try {
                        const date = new Date(timeStr);
                        // è¿”å›æ ‡å‡†æ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss
                        return date.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                    } catch (e) {
                        return timeStr;
                    }
                },

                async executeSearch() {
                    if (!this.selectedLog) {
                        ElMessage.warning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥å¿—é…ç½®');
                        return;
                    }

                    // éªŒè¯æ–‡ä»¶è¿‡æ»¤è®¾ç½®
                    if (this.searchForm.use_file_filter) {
                        const missingHosts = [];
                        this.groupedFiles.forEach(group => {
                            if (!this.searchForm.selected_files[group.host]) {
                                missingHosts.push(group.host);
                            }
                        });

                        if (missingHosts.length > 0) {
                            ElMessage.error(`è¯·ä¸ºä»¥ä¸‹ä¸»æœºé€‰æ‹©æ–‡ä»¶: ${missingHosts.join(', ')}`);
                            return;
                        }
                    }

                    this.searching = true;
                    this.hasSearched = true;

                    try {
                        const response = await axios.post(
                            `/api/v1/logs/${this.selectedLog.name}/search`,
                            this.searchForm
                        );

                        if (response.data.success) {
                            this.searchResults = response.data.data;
                            if (this.searchResults.total_matches === 0) {
                                ElMessage.info('æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•');
                            } else {
                                ElMessage.success(`æ‰¾åˆ° ${this.searchResults.total_matches} ä¸ªåŒ¹é…é¡¹`);
                            }
                        } else {
                            ElMessage.error('æœç´¢å¤±è´¥: ' + (response.data.error?.message || 'æœªçŸ¥é”™è¯¯'));
                            this.searchResults = null;
                        }
                    } catch (error) {
                        ElMessage.error('æœç´¢è¯·æ±‚å¤±è´¥: ' + error.message);
                        console.error('æœç´¢å¤±è´¥:', error);
                        this.searchResults = null;
                    } finally {
                        this.searching = false;
                    }
                }
            }
        });

        // ä½¿ç”¨ Element Plus å’Œå…¶æŒ‡ä»¤
        app.use(ElementPlus);

        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
    </script>
</body>

</html>