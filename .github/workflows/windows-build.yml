name: build-windows-exe

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install build deps
        run: |
          pip install -r requirements.txt
          pip install pyinstaller==6.8.0

      - name: Show Python info
        run: |
          python --version
          python -c "import sys; print(sys.platform)"

      - name: Build (onedir) via CLI (no spec)
        run: |
          pyinstaller \
            --name log-search-api \
            --onedir \
            --noconfirm \
            --clean \
            --add-data "templates;templates" \
            --add-data "static;static" \
            --additional-hooks-dir pyinstaller-hooks \
            --hidden-import engineio \
            --hidden-import socketio \
            --hidden-import engineio.async_drivers.threading \
            --hidden-import socketio.async_drivers.threading \
            --collect-all paramiko \
            main.py

      - name: Rename onedir folder
        run: |
          mkdir -p artifacts
          mv dist/log-search-api artifacts/log-search-api-onedir

      - name: Build (onefile) without spec
        run: |
          pyinstaller \
            --name log-search-api \
            --onefile \
            --noconfirm \
            --clean \
            --add-data "templates;templates" \
            --add-data "static;static" \
            --additional-hooks-dir pyinstaller-hooks \
            --hidden-import engineio \
            --hidden-import socketio \
            --hidden-import engineio.async_drivers.threading \
            --hidden-import socketio.async_drivers.threading \
            --collect-all paramiko \
            main.py

      - name: Move onefile exe
        run: |
          mv dist/log-search-api.exe artifacts/log-search-api-onefile.exe

      - name: Archive onedir
        shell: pwsh
        run: |
          Set-Location artifacts
          if (Test-Path log-search-api-onedir.zip) { Remove-Item log-search-api-onedir.zip }
          Compress-Archive -Path 'log-search-api-onedir/*' -DestinationPath 'log-search-api-onedir.zip'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-executables
          path: |
            artifacts/log-search-api-onefile.exe
            artifacts/log-search-api-onedir.zip
