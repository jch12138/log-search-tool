<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFTP æ–‡ä»¶ç®¡ç†</title>
  <link rel="icon" type="image/svg+xml" href="/static/icons/favicon-sftp.svg" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sftp.css') }}" />
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
      <h1 id="page-title">SFTP æ–‡ä»¶ç®¡ç†å™¨</h1>
      <div class="actions">
        <a href="/" class="btn btn-secondary">â† è¿”å›ä¸»é¡µ</a>
        <button class="btn btn-primary" id="new-conn-btn">+ æ–°å»ºè¿æ¥</button>
      </div>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
      <!-- å·¦ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <div class="sidebar-section">æ´»è·ƒè¿æ¥</div>
        <div id="connections-list">
          <div class="loading">æ­£åœ¨åŠ è½½...</div>
        </div>

        <div class="sidebar-section">å¯ç”¨æœåŠ¡å™¨</div>
        <div id="log-based-servers">
          <div class="loading">æ­£åœ¨åŠ è½½...</div>
        </div>
      </aside>

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="main-pane">
        <!-- å·¥å…·æ  -->
        <div class="topbar">
          <div class="topbar-row">
            <div class="path-input-container">
              <input id="path-input" class="input" type="text" placeholder="è¯·é€‰æ‹©è¿æ¥" readonly />
              <button id="path-nav-btn" class="btn btn-sm" disabled title="è·³è½¬åˆ°æŒ‡å®šè·¯å¾„">è·³è½¬</button>
            </div>
            <div class="topbar-actions">
              <button id="upload-btn" class="btn btn-sm" disabled title="ä¸Šä¼ æ–‡ä»¶">ğŸ“¤ ä¸Šä¼ </button>
              <button id="mkdir-btn" class="btn btn-sm" disabled title="æ–°å»ºç›®å½•">ğŸ“ æ–°å»ºç›®å½•</button>
              <button id="rename-btn" class="btn btn-sm" disabled title="é‡å‘½åé€‰ä¸­é¡¹ï¼ˆå•é€‰ï¼‰">âœï¸ é‡å‘½å</button>
              <button id="batch-download-btn" class="btn btn-sm" disabled title="æ‰¹é‡ä¸‹è½½é€‰ä¸­æ–‡ä»¶">â¬‡ æ‰¹é‡ä¸‹è½½</button>
              <button id="batch-delete-btn" class="btn btn-sm btn-danger" disabled title="æ‰¹é‡åˆ é™¤é€‰ä¸­é¡¹">ğŸ—‘ æ‰¹é‡åˆ é™¤</button>
              <button id="refresh-btn" class="btn btn-sm" disabled title="åˆ·æ–°å½“å‰ç›®å½•">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-table-wrapper" id="file-table-wrapper">
          <div class="loading">è¯·å…ˆè¿æ¥åˆ° SFTP æœåŠ¡å™¨</div>
        </div>
      </main>
    </div>
  </div>

  <!-- è¿æ¥æ¨¡æ€æ¡† -->
  <div class="modal" id="connect-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">è¿æ¥ SFTP æœåŠ¡å™¨</h3></div>
      <form id="connect-form">
        <div class="form-group"><label>è¿æ¥åç§°</label><input type="text" id="connection-name" placeholder="å¯é€‰ï¼Œå¦‚ï¼šç”Ÿäº§æœåŠ¡å™¨" /></div>
        <div class="form-group"><label>æœåŠ¡å™¨åœ°å€</label><input type="text" id="host" required placeholder="192.168.1.100" /></div>
        <div class="form-group"><label>ç«¯å£</label><input type="number" id="port" value="22" required /></div>
        <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" id="username" required /></div>
        <div class="form-group"><label>å¯†ç </label><input type="password" id="password" required /></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" id="cancel-connect">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">è¿æ¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
  <div class="modal" id="upload-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">ä¸Šä¼ æ–‡ä»¶</h3></div>
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
        <div style="font-size:12px;color:#999;">æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼</div>
      </div>
      <input type="file" id="file-input" multiple style="display:none" />
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
        <button type="button" class="btn btn-secondary" id="close-upload">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- æ–°å»ºç›®å½•æ¨¡æ€æ¡† -->
  <div class="modal" id="mkdir-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">æ–°å»ºç›®å½•</h3></div>
      <form id="mkdir-form">
        <div class="form-group"><label>ç›®å½•åç§°</label><input type="text" id="dir-name" required placeholder="è¾“å…¥ç›®å½•åç§°" /></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" id="cancel-mkdir">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">åˆ›å»º</button>
        </div>
      </form>
    </div>
  </div>

  <!-- é‡å‘½åæ¨¡æ€æ¡† -->
  <div class="modal" id="rename-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">é‡å‘½å</h3></div>
      <form id="rename-form">
        <div class="form-group">
          <label>å½“å‰åç§°</label>
          <input type="text" id="old-name" readonly style="background:#f5f7fa;cursor:not-allowed;" />
        </div>
        <div class="form-group">
          <label>æ–°åç§°</label>
          <input type="text" id="new-name" required placeholder="è¾“å…¥æ–°åç§°" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" id="cancel-rename">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">é‡å‘½å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // State
    let currentConnectionId = null;
    let currentPath = '/';
    let currentItems = [];
    let fileSelection = new Set();
    const sortState = { key: 'name', dir: 'asc' };
    let renameTargetPath = null; // å­˜å‚¨è¦é‡å‘½åçš„é¡¹ç›®è·¯å¾„

  // æ¯ä¸ªè¿æ¥çš„ç‹¬ç«‹çŠ¶æ€ï¼ˆè·¯å¾„ã€æ‰€é€‰æ–‡ä»¶ï¼‰
  const connectionStates = {};
  // æ´»è·ƒè¿æ¥ç¼“å­˜ï¼Œç”¨äºæ ‡é¢˜æ›´æ–°
  let activeConnectionsCache = [];

    // API prefix
    const API = '/api/v1';

    // Helpers
    const $ = (id) => document.getElementById(id);
    const showMessage = (msg, type='success') => {
      const el = document.createElement('div');
      el.className = 'message ' + (type === 'error' ? 'error' : 'success');
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    };

    function enableToolbar() {
      ['upload-btn','mkdir-btn','refresh-btn','path-nav-btn','batch-download-btn','batch-delete-btn','rename-btn'].forEach(id => {
        const el = $(id);
        if (el && !id.includes('batch') && id !== 'rename-btn') el.disabled = false;
      });
      const input = $('path-input');
      input.readOnly = false; input.placeholder = 'ç‚¹å‡»è¾“å…¥è·¯å¾„æˆ–ç›´æ¥ç¼–è¾‘å½“å‰è·¯å¾„';
      updateBatchButtons();
    }
    function disableToolbar() {
      ['upload-btn','mkdir-btn','refresh-btn','path-nav-btn','batch-download-btn','batch-delete-btn','rename-btn'].forEach(id => {
        const el = $(id);
        if (el) el.disabled = true;
      });
      const input = $('path-input');
      input.readOnly = true; input.placeholder = 'è¯·é€‰æ‹©è¿æ¥'; input.value = '';
    }

    async function fetchJSON(url, options={}){
      const r = await fetch(url, options);
      const j = await r.json();
      if (!j.success) throw new Error(j.error?.message || 'è¯·æ±‚å¤±è´¥');
      return j.data;
    }

    async function loadActiveConnections(){
      try {
        const data = await fetchJSON(`${API}/sftp/connections`);
        renderActiveConnections(data.connections || []);
      } catch (e) {
        // æ¸…ç©º
        renderActiveConnections([]);
      }
    }

    function renderActiveConnections(conns){
      activeConnectionsCache = conns || [];
      const container = $('connections-list');
      if (!conns.length) {
        container.innerHTML = '<div class="item" style="text-align:center;cursor:default;">æš‚æ— æ´»è·ƒè¿æ¥</div>';
        return;
      }
      container.innerHTML = conns.map(c => {
        return `<div class="item connection-item" data-id="${c.connection_id}">
          <div class="info">
            <div class="title">${c.username}@${c.host}</div>
            <div class="meta">ç«¯å£: ${c.port}</div>
          </div>
          <div class="actions">
            <button class="btn btn-danger js-disconnect" style="font-size:12px;padding:4px 8px;">æ–­å¼€</button>
          </div>
        </div>`;
      }).join('');

      container.querySelectorAll('.connection-item').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('button')) return; // é˜²æ­¢æŒ‰é’®äº‹ä»¶å†’æ³¡
          const id = el.getAttribute('data-id');
          selectConnection(id, el);
        });
        
        el.querySelector('.js-disconnect').addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = el.getAttribute('data-id');
          try{
            await fetchJSON(`${API}/sftp/disconnect`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({connection_id: id})});
            if (connectionStates[id]) delete connectionStates[id];
            if (currentConnectionId === id) { 
              currentConnectionId = null; 
              disableToolbar(); 
              $('file-table-wrapper').innerHTML = '<div class="loading">å·²æ–­å¼€è¿æ¥</div>'; 
            }
            // é‡æ–°åŠ è½½è¿æ¥åˆ—è¡¨å’ŒæœåŠ¡å™¨åˆ—è¡¨
            loadActiveConnections();
            loadAvailableServers(); // é‡æ–°åŠ è½½å¯ç”¨æœåŠ¡å™¨åˆ—è¡¨
            showMessage('è¿æ¥å·²æ–­å¼€', 'success');
          }catch(err){ 
            showMessage(err.message, 'error'); 
          }
        });
      });
    }

    async function loadAvailableServers(){
      try {
        const [serversData, connectionsData] = await Promise.all([
          fetchJSON(`${API}/servers?type=sftp`),
          fetchJSON(`${API}/sftp/connections`).catch(() => ({ connections: [] }))
        ]);
        
        const servers = serversData.servers || [];
        const activeConnections = connectionsData.connections || [];
        const container = $('log-based-servers');
        
        // åˆ›å»ºå·²è¿æ¥æœåŠ¡å™¨çš„æ˜ å°„ï¼Œç”¨äºè¿‡æ»¤
        const connectedServerIds = new Set();
        activeConnections.forEach(conn => {
          // åŸºäº username@host:port åˆ›å»ºæœåŠ¡å™¨ID
          const serverId = `${conn.username}@${conn.host}:${conn.port}`;
          connectedServerIds.add(serverId);
        });
        
        // è¿‡æ»¤æ‰å·²è¿æ¥çš„æœåŠ¡å™¨
        const availableServers = servers.filter(server => !connectedServerIds.has(server.server_id));
        
        if (!availableServers.length) { 
          container.innerHTML = '<div class="item" style="text-align:center;cursor:default;">æš‚æ— å¯ç”¨æœåŠ¡å™¨</div>'; 
          return; 
        }
        
        container.innerHTML = availableServers.map(server => {
          return `<div class="item server-item" 
                      data-server-id="${server.server_id}"
                      data-host="${server.host}" 
                      data-port="${server.port}" 
                      data-username="${server.username}" 
                      data-server-name="${server.server_name}">
            <div class="info">
              <div class="title">${server.username}@${server.host}</div>
              <div class="meta">ç«¯å£: ${server.port}</div>
            </div>
            <div class="actions">
              <button class="btn btn-primary js-connect" style="font-size:12px;padding:4px 8px;">è¿æ¥</button>
            </div>
          </div>`;
        }).join('');

        container.querySelectorAll('.server-item .js-connect').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const card = btn.closest('.server-item');
            const serverId = card.getAttribute('data-server-id');
            const serverName = card.getAttribute('data-server-name');
            
            // è·å–æœåŠ¡å™¨ä¿¡æ¯
            const server = availableServers.find(s => s.server_id === serverId);
            if (!server) {
              showMessage('æœåŠ¡å™¨ä¿¡æ¯ä¸å­˜åœ¨', 'error');
              return;
            }
            
            try {
              // ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨çš„ç¬¬ä¸€ä¸ªæ—¥å¿—é…ç½®è¿æ¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
              const firstLog = server.log_configs && server.log_configs.length > 0 ? server.log_configs[0] : null;
              
              const requestData = firstLog ? {
                log_name: firstLog.log_name,
                ssh_index: firstLog.ssh_index,
                connection_name: serverName
              } : {
                server_id: serverId,
                connection_name: serverName
              };
              
              const res = await fetchJSON(`${API}/sftp/connect-by-config`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify(requestData) 
              });
              
              showMessage('è¿æ¥æˆåŠŸ','success');
              updatePageTitle(res);
              
              // è¿æ¥åé»˜è®¤è·³è½¬åˆ°æ ¹ç›®å½•
              const connId = res.connection_id;
              const rootDir = '/';
              
              // è®¾ç½®ä¸ºå½“å‰è¿æ¥å¹¶å¯¼èˆªåˆ°æ ¹ç›®å½•
              currentConnectionId = connId;
              if (!connectionStates[connId]) {
                connectionStates[connId] = { path: rootDir, selection: new Set() };
              } else {
                connectionStates[connId].path = rootDir;
              }
              
              enableToolbar();
              $('path-input').value = rootDir;
              await loadDirectory(rootDir);
              
              // é‡æ–°åŠ è½½è¿æ¥åˆ—è¡¨å’ŒæœåŠ¡å™¨åˆ—è¡¨ï¼Œå®ç°çŠ¶æ€åˆ‡æ¢
              loadActiveConnections();
              loadAvailableServers(); // é‡æ–°åŠ è½½å¯ç”¨æœåŠ¡å™¨åˆ—è¡¨ï¼Œå·²è¿æ¥çš„æœåŠ¡å™¨ä¼šè¢«è¿‡æ»¤æ‰
              
            } catch(err) { 
              showMessage(err.message, 'error'); 
            }
          });
        });
      } catch (e) {
        $('log-based-servers').innerHTML = '<div class="item" style="text-align:center;cursor:default;">åŠ è½½æœåŠ¡å™¨å¤±è´¥</div>';
      }
    }

    function openConnectModal(prefill={}){
      $('connect-modal').classList.add('active');
      $('connection-name').value = prefill.connection_name || '';
      $('host').value = prefill.host || '';
      $('port').value = prefill.port || 22;
      $('username').value = prefill.username || '';
      $('password').value = '';
    }

    function closeConnectModal(){ $('connect-modal').classList.remove('active'); $('connect-form').reset(); }
    function openUploadModal(){ if(!currentConnectionId){ return showMessage('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨','error'); } $('upload-modal').classList.add('active'); }
    function closeUploadModal(){ $('upload-modal').classList.remove('active'); $('file-input').value=''; }
    function openMkdirModal(){ if(!currentConnectionId){ return showMessage('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨','error'); } $('mkdir-modal').classList.add('active'); }
    function closeMkdirModal(){ $('mkdir-modal').classList.remove('active'); $('mkdir-form').reset(); }
    
    function openRenameModal(){ 
      if(!currentConnectionId){ return showMessage('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨','error'); }
      if(fileSelection.size !== 1){ return showMessage('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•è¿›è¡Œé‡å‘½å','error'); }
      const path = Array.from(fileSelection)[0];
      const item = currentItems.find(i => joinPath(currentPath, i.original_name || i.name) === path);
      if(!item){ return showMessage('æœªæ‰¾åˆ°é€‰ä¸­é¡¹','error'); }
      renameTargetPath = path;
      $('old-name').value = item.name;
      $('new-name').value = item.name;
      $('rename-modal').classList.add('active');
      setTimeout(() => {
        const input = $('new-name');
        input.focus();
        input.select();
      }, 100);
    }
    
    function closeRenameModal(){ 
      $('rename-modal').classList.remove('active'); 
      $('rename-form').reset(); 
      renameTargetPath = null;
    }

    function updatePageTitle(info){
      if(!info) return;
      if(info.username && info.host){
        document.title = `${info.username}@${info.host}`;
        const h = document.getElementById('page-title');
        if(h) h.textContent = `${info.username}@${info.host}`;
      }
    }

    async function connectViaForm(e){
      e.preventDefault();
      const payload = {
        connection_name: $('connection-name').value.trim(),
        host: $('host').value.trim(),
        port: parseInt($('port').value, 10) || 22,
        username: $('username').value.trim(),
        password: $('password').value
      };
      if(!payload.host || !payload.username || !payload.password){ return showMessage('è¯·å¡«å†™å¿…å¡«é¡¹','error'); }
      try{
        const info = await fetchJSON(`${API}/sftp/connect`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        closeConnectModal();
        showMessage('è¿æ¥æˆåŠŸ','success');
        updatePageTitle(info);
        loadActiveConnections();
        loadAvailableServers(); // åˆ·æ–°å¯ç”¨æœåŠ¡å™¨åˆ—è¡¨ï¼Œç§»é™¤å·²è¿æ¥çš„æœåŠ¡å™¨
      }catch(err){ showMessage(err.message, 'error'); }
    }

    function selectConnection(id, el){
      // ä¿å­˜ä¸Šä¸€ä¸ªè¿æ¥çŠ¶æ€
      if (currentConnectionId && connectionStates[currentConnectionId]) {
        connectionStates[currentConnectionId].path = currentPath;
        connectionStates[currentConnectionId].selection = new Set(fileSelection);
      }
      currentConnectionId = id;
      if (!connectionStates[id]) connectionStates[id] = { path: '/', selection: new Set() };
      currentPath = connectionStates[id].path;
      fileSelection = new Set(connectionStates[id].selection);
      document.querySelectorAll('.item.connection-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      enableToolbar();
      $('path-input').value = currentPath;
      loadDirectory(currentPath);
  const info = activeConnectionsCache.find(c=>c.connection_id===id);
  if(info) updatePageTitle(info);
    }

    async function loadDirectory(path){
      if (!currentConnectionId) return;
      // è®°å½•å½“å‰è¿æ¥çš„çŠ¶æ€
      if (connectionStates[currentConnectionId]) connectionStates[currentConnectionId].path = path;
      $('file-table-wrapper').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      try{
        const data = await fetchJSON(`${API}/sftp/list`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ connection_id: currentConnectionId, path }) });
        currentPath = data.current_path;
        $('path-input').value = currentPath;
        currentItems = data.items || [];
        renderTable();
      }catch(err){ $('file-table-wrapper').innerHTML = `<div class="loading">åŠ è½½å¤±è´¥ï¼š${err.message}</div>`; }
    }

    function renderTable(){
      const dirs = currentItems.filter(i => i.is_directory);
      const files = currentItems.filter(i => !i.is_directory);
      const k = sortState.key; const dir = sortState.dir;
      const cmp = (a,b) => { let av=a[k], bv=b[k]; if(k==='name'){ av=a.name.toLowerCase(); bv=b.name.toLowerCase(); } if(k==='size'){ av=a.size||0; bv=b.size||0; } if(k==='modified_time'){ av=a.modified_time; bv=b.modified_time; } if(av===bv) return 0; const c = av>bv?1:-1; return dir==='asc'?c:-c; };
      files.sort(cmp);
      const rows = [];
      if (currentPath !== '/') {
        const parent = currentPath.split('/').slice(0,-1).join('/') || '/';
        rows.push(`<tr onclick="loadDirectory('${parent}')"><td class='checkbox-cell'></td><td class='name'>..</td><td>â€”</td><td></td><td></td><td></td></tr>`);
      }
      [...dirs, ...files].forEach(f => {
        // ä½¿ç”¨åŸå§‹æ–‡ä»¶åè¿›è¡Œæ“ä½œï¼Œæ˜¾ç¤ºè½¬æ¢åçš„æ–‡ä»¶å
        const originalName = f.original_name || f.name;
        const displayName = f.name;
        const checked = fileSelection.has(joinPath(currentPath, originalName)) ? 'checked' : '';
        const fullPath = joinPath(currentPath, originalName);
        const actions = f.is_directory ? '' : `<button class='btn btn-sm btn-secondary' onclick="event.stopPropagation();downloadFile('${fullPath}')">ä¸‹è½½</button>`;
        const delBtn = `<button class='btn btn-sm btn-danger' onclick="event.stopPropagation();deleteItem('${fullPath}', ${f.is_directory})">åˆ é™¤</button>`;
        rows.push(`<tr ${f.is_directory?`onclick=\"loadDirectory('${fullPath}')\"`:''} class='${fileSelection.has(fullPath)?'row-selected':''}'>
          <td class='checkbox-cell'><input type='checkbox' ${checked} onclick="toggleSelect(event,'${fullPath}')"></td>
          <td class='name' title='${displayName}'>${f.is_directory?'<span class=\"tag-dir\">DIR</span> ':''}${displayName}</td>
          <td>${f.is_directory?'â€‘':f.size_human||'-'}</td>
          <td>${f.modified_time||''}</td>
          <td>${f.permissions||''}</td>
          <td class='actions'><div class='action-buttons'>${actions}${delBtn}</div></td>
        </tr>`);
      });
      const table = `<table class='table'>
        <thead><tr>
          <th class='checkbox-cell'><input type='checkbox' id='header-select' ${allVisibleSelected()? 'checked':''} onclick='toggleSelectVisible(event)'></th>
          <th>åç§° ${sortableHeader('name')}</th>
          <th>å¤§å° ${sortableHeader('size')}</th>
          <th>ä¿®æ”¹æ—¶é—´ ${sortableHeader('modified_time')}</th>
          <th>æƒé™</th>
          <th class='actions'>æ“ä½œ</th>
        </tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan='6'><div class='loading'>æ— æ–‡ä»¶</div></td></tr>`}</tbody>
      </table>`;
      $('file-table-wrapper').innerHTML = table;
      updateBatchButtons();
    }

    function joinPath(base, name){ if(base.endsWith('/')) return base + name; if(base === '/') return '/' + name; return base + '/' + name; }
    function sortableHeader(key){ const active = sortState.key===key; const sym = active ? (sortState.dir==='asc'?'â–²':'â–¼') : 'â†•'; return `<span style='cursor:pointer;color:${active?'var(--color-accent)':'#94a3b8'}' onclick="changeSort('${key}')">${sym}</span>`; }
    function changeSort(k){ if(sortState.key===k) sortState.dir = sortState.dir==='asc'?'desc':'asc'; else { sortState.key=k; sortState.dir='asc'; } renderTable(); }

    function toggleSelect(e, p){ e.stopPropagation(); if(fileSelection.has(p)) fileSelection.delete(p); else fileSelection.add(p); if (connectionStates[currentConnectionId]) connectionStates[currentConnectionId].selection = new Set(fileSelection); renderTable(); }
    function allVisibleSelected(){ const all = currentItems.map(i => joinPath(currentPath, i.original_name || i.name)); return all.length>0 && all.every(p => fileSelection.has(p)); }
    function toggleSelectVisible(e){ e.stopPropagation(); const all = currentItems.map(i => joinPath(currentPath, i.original_name || i.name)); if (all.every(p => fileSelection.has(p))) all.forEach(p => fileSelection.delete(p)); else all.forEach(p => fileSelection.add(p)); if (connectionStates[currentConnectionId]) connectionStates[currentConnectionId].selection = new Set(fileSelection); renderTable(); }
    function updateBatchButtons(){ 
      const hasSel = fileSelection.size>0; 
      const hasOneSel = fileSelection.size===1;
      ['batch-delete-btn','batch-download-btn','batch-zip-btn'].forEach(id => { 
        const el=document.getElementById(id); 
        if(el) el.disabled = !currentConnectionId || !hasSel; 
      }); 
      const renameBtn = document.getElementById('rename-btn');
      if(renameBtn) renameBtn.disabled = !currentConnectionId || !hasOneSel;
    }

    async function deleteItem(path, isDir){ if(!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ª${isDir?'ç›®å½•':'æ–‡ä»¶'}å—?`)) return; try{ await fetchJSON(`${API}/sftp/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ connection_id: currentConnectionId, remote_path: path, is_directory: !!isDir }) }); showMessage('åˆ é™¤æˆåŠŸ'); fileSelection.delete(path); loadDirectory(currentPath); } catch(err){ showMessage(err.message, 'error'); } }
    
    function downloadFile(path){ if(!currentConnectionId) return; const url = `${API}/sftp/download?connection_id=${encodeURIComponent(currentConnectionId)}&remote_path=${encodeURIComponent(path)}`; const w = window.open(url, '_blank'); if(!w) showMessage('æµè§ˆå™¨é˜»æ­¢äº†ä¸‹è½½çª—å£', 'error'); }

    // æ‰¹é‡åˆ é™¤
    async function batchDelete(){ 
      if(!fileSelection.size) return; 
      if(!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${fileSelection.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) return; 
      const items = Array.from(fileSelection);
      let successCount = 0;
      for(const path of items){
        const item = currentItems.find(i => joinPath(currentPath, i.original_name || i.name) === path);
        const isDir = item ? item.is_directory : false;
        try{ 
          await fetchJSON(`${API}/sftp/delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ connection_id: currentConnectionId, remote_path: path, is_directory: isDir }) }); 
          fileSelection.delete(path);
          successCount++;
        }catch(err){ 
          showMessage(`åˆ é™¤ ${path} å¤±è´¥: ${err.message}`, 'error'); 
        }
      }
      if(successCount > 0) showMessage(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªé¡¹ç›®`);
      loadDirectory(currentPath); 
    }

    // æ‰¹é‡ä¸‹è½½
    function batchDownload(){ 
      if(!fileSelection.size) return showMessage('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶','error'); 
      const files = Array.from(fileSelection).filter(path => {
        const item = currentItems.find(i => joinPath(currentPath, i.original_name || i.name) === path);
        return item && !item.is_directory;
      });
      if(!files.length) return showMessage('æ‰€é€‰é¡¹ç›®ä¸­æ²¡æœ‰æ–‡ä»¶','error');
      files.forEach(path => downloadFile(path));
      showMessage(`å·²å¼€å§‹ä¸‹è½½ ${files.length} ä¸ªæ–‡ä»¶`);
    }

    // ä¸Šä¼ /æ‰“åŒ…ä¸‹è½½ï¼ˆæŒ‰é’®åœ¨å·¥å…·æ ä¹‹å¤–ï¼ŒæŒ‰éœ€æ‹“å±•ï¼‰
    async function uploadFiles(files){ if(!currentConnectionId) return showMessage('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨','error'); let successCount = 0; for(const file of files){ const fd = new FormData(); fd.append('file', file); fd.append('connection_id', currentConnectionId); fd.append('remote_path', currentPath); try{ const r = await fetch(`${API}/sftp/upload`, { method:'POST', body: fd }); const j = await r.json(); if(!j.success) throw new Error(j.error?.message||'ä¸Šä¼ å¤±è´¥'); successCount++; }catch(e){ showMessage(`${file.name} ä¸Šä¼ å¤±è´¥: ${e.message}`, 'error'); } } if(successCount > 0) showMessage(`æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶`); closeUploadModal(); loadDirectory(currentPath); }

    // ç›®å½•åˆ›å»º
    async function createDirectory(e){ e.preventDefault(); const name = $('dir-name').value.trim(); if(!name) return; try{ await fetchJSON(`${API}/sftp/mkdir`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ connection_id: currentConnectionId, remote_path: currentPath, dir_name: name }) }); closeMkdirModal(); showMessage('ç›®å½•åˆ›å»ºæˆåŠŸ'); loadDirectory(currentPath); }catch(err){ showMessage(err.message, 'error'); } }

    // é‡å‘½å
    async function renameItem(e){ 
      e.preventDefault(); 
      const newName = $('new-name').value.trim(); 
      if(!newName || !renameTargetPath) return; 
      const oldName = $('old-name').value;
      if(newName === oldName){ 
        closeRenameModal(); 
        return showMessage('åç§°æœªæ”¹å˜','error'); 
      }
      try{ 
        await fetchJSON(`${API}/sftp/rename`, { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ 
            connection_id: currentConnectionId, 
            old_path: renameTargetPath, 
            new_name: newName 
          }) 
        }); 
        closeRenameModal(); 
        showMessage('é‡å‘½åæˆåŠŸ'); 
        fileSelection.delete(renameTargetPath);
        loadDirectory(currentPath); 
      }catch(err){ 
        showMessage(err.message, 'error'); 
      } 
    }

    // è·¯å¾„è¾“å…¥ç›¸å…³
    function navigateToPath(){ if(!currentConnectionId) return; const input = $('path-input'); let target = (input.value||'').trim(); if(!target) return; if(!target.startsWith('/')) target = '/' + target; if(target === currentPath) return; loadDirectory(target); input.readOnly = true; }

    // åˆå§‹åŒ–äº‹ä»¶
    function setupEvents(){
      $('new-conn-btn').addEventListener('click', () => openConnectModal());
      $('cancel-connect').addEventListener('click', closeConnectModal);
      $('connect-form').addEventListener('submit', connectViaForm);

      $('upload-btn').addEventListener('click', openUploadModal);
      $('close-upload').addEventListener('click', closeUploadModal);
      $('upload-area').addEventListener('click', () => $('file-input').click());
      $('file-input').addEventListener('change', (e) => uploadFiles(e.target.files));
      ['dragover','dragleave','drop'].forEach(evt => $('upload-area').addEventListener(evt, ev => { ev.preventDefault(); if(evt==='dragover') $('upload-area').classList.add('dragover'); if(evt==='dragleave') $('upload-area').classList.remove('dragover'); if(evt==='drop'){ $('upload-area').classList.remove('dragover'); uploadFiles(ev.dataTransfer.files); } }));

      $('mkdir-btn').addEventListener('click', openMkdirModal);
      $('cancel-mkdir').addEventListener('click', closeMkdirModal);
      $('mkdir-form').addEventListener('submit', createDirectory);

      $('rename-btn').addEventListener('click', openRenameModal);
      $('cancel-rename').addEventListener('click', closeRenameModal);
      $('rename-form').addEventListener('submit', renameItem);

      $('refresh-btn').addEventListener('click', () => currentConnectionId && loadDirectory(currentPath));
      $('batch-download-btn').addEventListener('click', batchDownload);
      $('batch-delete-btn').addEventListener('click', batchDelete);
      $('path-nav-btn').addEventListener('click', navigateToPath);
      $('path-input').addEventListener('keydown', (e) => { if(e.key==='Enter') navigateToPath(); });
      $('path-input').addEventListener('click', (e) => { if(currentConnectionId) e.target.readOnly = false; });
      $('path-input').addEventListener('blur', (e) => { if(currentConnectionId) e.target.readOnly = true; });

      // å…³é—­æ¨¡æ€ï¼ˆç‚¹å‡»é®ç½©ï¼‰
      document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target===m) m.classList.remove('active'); }));
    }

    // å¯åŠ¨
    document.addEventListener('DOMContentLoaded', () => {
      disableToolbar();
      setupEvents();
      loadActiveConnections();
      loadAvailableServers();
      // single æ¨¡å¼ï¼š ?single=1&log_name=xxx&ssh_index=0
      const params = new URLSearchParams(window.location.search);
      if (params.get('single') === '1') {
        const logName = params.get('log_name') || '';
        const sshIndex = parseInt(params.get('ssh_index') || '0', 10) || 0;
        // éšè—ä¾§æ ä¸æ–°å»ºè¿æ¥æŒ‰é’®
        const sidebar = document.querySelector('.sidebar'); if(sidebar) sidebar.style.display='none';
        const actions = document.querySelector('.actions'); if(actions){ const btn = document.getElementById('new-conn-btn'); if(btn) btn.style.display='none'; }
        // è°ƒæ•´å¸ƒå±€å®½åº¦
        const mainLayout = document.querySelector('.main-layout'); if(mainLayout){ mainLayout.style.gridTemplateColumns = '1fr'; }
        // ç›´æ¥é€šè¿‡é…ç½®è¿æ¥
        (async ()=>{
          try {
            const resp = await fetch(`${API}/sftp/connect-by-config`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ log_name: logName, ssh_index: sshIndex, connection_name: logName? (logName+"#"+sshIndex): 'log'})});
            const j = await resp.json();
            if(!j.success) return;
            currentConnectionId = j.data.connection_id;
            enableToolbar();
            $('path-input').value = '/';
            loadDirectory('/');
            updatePageTitle(j.data);
          } catch(e) { /* ignore */ }
        })();
      }
    });
  </script>
</body>
</html>
