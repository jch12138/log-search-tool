<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>托管测试组-导航站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/element-plus.css">
    
    <style>
        [v-cloak] { display: none; }
        .copy-hover:hover { background-color: #f1f5f9; cursor: pointer; border-radius: 4px; }
        .copy-hover:active { background-color: #e2e8f0; }
        .group-action-btn { opacity: 0; transition: opacity 0.2s; }
        .group:hover .group-action-btn { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-blue-100">

    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">TG</div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">托管测试组</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <div v-if="isEditMode" class="flex items-center gap-3 animate-fade-in">
                        <span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-1 rounded border border-green-100">
                            <i class="fa-solid fa-user-check mr-1"></i> <span>[[ currentAdminId ]]</span>
                        </span>
                        <button @click="openAddGroupDialog" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded shadow-sm transition">
                            <i class="fa-solid fa-folder-plus mr-1"></i> 新建分组
                        </button>
                        <button @click="saveConfig" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow-sm transition">
                            <i class="fa-solid fa-save mr-1"></i> 保存配置
                        </button>
                        <button @click="exitEditMode" class="text-sm text-slate-500 hover:text-slate-700 px-2">退出</button>
                    </div>
                    <button v-else @click="requestAuth" class="text-sm text-slate-500 hover:text-blue-600 transition px-3 py-1.5 border border-slate-200 rounded shadow-sm" title="管理模式">
                        编辑
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">
            <div v-if="workspaceData.length === 0" class="text-center py-20 text-slate-400">
                <i class="fa-solid fa-inbox text-4xl mb-4"></i>
                <p>暂无资源配置，请点击右上角进入管理模式添加。</p>
            </div>

            <section v-for="(group, gIndex) in workspaceData" :key="group.id" class="mb-8 group">
                <!-- Group Header -->
                <div class="flex items-center justify-between mb-5 pb-2 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-slate-800">[[ group.title ]]</h2>
                        <div v-if="shouldShowEnvToggle(group)" class="flex items-center gap-1 ml-4">
                            <button
                                v-for="env in envOptions"
                                :key="env.value"
                                type="button"
                                @click="setGroupEnv(group, env.value)"
                                :title="env.label + ' 环境' + (getActiveEnv(group) === env.value ? ' (当前)' : '')"
                                :class="[
                                    'text-xs font-semibold px-2 py-1 rounded border transition flex items-center gap-1',
                                    getActiveEnv(group) === env.value
                                        ? 'bg-blue-600 text-white border-blue-600 shadow-sm'
                                        : 'bg-white text-slate-500 border-slate-200 hover:bg-blue-50 hover:text-blue-600'
                                ]"
                            >
                                <i v-if="env.icon" :class="[env.icon, 'text-[10px]']"></i>
                                <span>[[ env.label ]]</span>
                            </button>
                        </div>
                    </div>
                    <div v-if="isEditMode" class="group-action-btn flex gap-2">
                        <button @click="editGroup(gIndex)" class="text-xs text-blue-500 hover:bg-blue-50 px-2 py-1 rounded"><i class="fa-solid fa-pen"></i> 编辑</button>
                        <button @click="moveGroup(gIndex, -1)" :disabled="gIndex === 0" class="text-xs text-slate-400 hover:text-slate-600 px-2 py-1 disabled:opacity-30"><i class="fa-solid fa-arrow-up"></i></button>
                        <button @click="moveGroup(gIndex, 1)" :disabled="gIndex === workspaceData.length - 1" class="text-xs text-slate-400 hover:text-slate-600 px-2 py-1 disabled:opacity-30"><i class="fa-solid fa-arrow-down"></i></button>
                        <button @click="deleteGroup(gIndex)" class="text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded"><i class="fa-solid fa-trash"></i> 删除</button>
                    </div>
                </div>

                <!-- Links Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                    <a v-for="(item, lIndex) in getEnvItems(group)" :key="lIndex" :href="item.url" target="_blank" class="relative block p-4 bg-white rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-300 transition group/card">
                        <div v-if="isEditMode" class="absolute top-2 right-2 z-10 flex gap-1 opacity-0 group-hover/card:opacity-100 transition-opacity bg-white/80 rounded backdrop-blur-sm">
                            <button @click.prevent="editLink(gIndex, lIndex)" class="text-blue-400 hover:text-blue-600 p-1"><i class="fa-solid fa-pen"></i></button>
                            <button @click.prevent="deleteLink(gIndex, lIndex)" class="text-slate-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="flex flex-col gap-1">
                            <h3 class="font-semibold text-slate-800 text-sm group-hover/card:text-blue-600">[[ item.name ]]</h3>
                            <p class="text-xs text-slate-500 line-clamp-2">[[ item.desc ]]</p>
                        </div>
                    </a>
                    <!-- Add Link Button -->
                    <button v-if="isEditMode" @click="openAddLinkDialog(gIndex)" class="flex flex-col items-center justify-center p-4 rounded-lg border-2 border-dashed border-slate-200 text-slate-400 hover:border-blue-400 hover:text-blue-500 transition h-full min-h-[80px]">
                        <i class="fa-solid fa-plus text-lg mb-1"></i>
                        <span class="text-xs font-medium">添加链接</span>
                    </button>
                </div>

                <!-- Databases Table -->
                <div v-if="(getEnvDbs(group).length > 0) || isEditMode" class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden mb-6">
                    <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-slate-700"><i class="fa-solid fa-database mr-2"></i>数据库资源</h3>
                        <span class="text-xs text-slate-400">点击表格内容即可复制</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="bg-white text-slate-500 border-b border-slate-100">
                                    <th class="px-4 py-2 font-medium w-1/4">名称</th>
                                    <th class="px-4 py-2 font-medium w-1/4">Host:Port</th>
                                    <th class="px-4 py-2 font-medium w-1/6">User</th>
                                    <th class="px-4 py-2 font-medium w-1/4">Password</th>
                                    <th v-if="isEditMode" class="px-4 py-2 font-medium text-right w-20">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="(db, dIndex) in getEnvDbs(group)" :key="dIndex" class="hover:bg-slate-50 transition-colors">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-server text-slate-300"></i>
                                            <span class="font-medium text-slate-700">[[ db.name ]]</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 font-mono text-xs text-slate-600 copy-hover" @click="copyToClipboard(`${db.host}:${db.port}`)" title="点击复制">[[ db.host ]]:[[ db.port ]]</td>
                                    <td class="px-4 py-3 font-mono text-xs text-slate-600 copy-hover" @click="copyToClipboard(db.user)" title="点击复制">[[ db.user ]]</td>
                                    <td class="px-4 py-3 font-mono text-xs text-pink-600 bg-pink-50/50 rounded copy-hover select-all" @click="copyToClipboard(db.pass)" title="点击复制">[[ db.pass ]]</td>
                                    <td v-if="isEditMode" class="px-4 py-3 text-right">
                                        <button @click="editDb(gIndex, dIndex)" class="text-blue-400 hover:text-blue-600 mr-2"><i class="fa-solid fa-pen"></i></button>
                                        <button @click="deleteDb(gIndex, dIndex)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="isEditMode" class="bg-slate-50">
                                    <td colspan="5" class="px-4 py-2 text-center border-t border-dashed border-slate-200">
                                        <button @click="openAddDbDialog(gIndex)" class="text-xs text-blue-600 hover:text-blue-800 font-medium py-1">
                                            <i class="fa-solid fa-plus mr-1"></i> 添加数据库
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <!-- Dialogs -->
        <!-- Group Dialog -->
        <el-dialog v-model="dialogs.group.visible" :title="dialogs.group.isEdit ? '编辑分组' : '新建分组'" width="500px">
            <el-form :model="forms.group" label-width="80px">
                <el-form-item label="标题">
                    <el-input v-model="forms.group.title" placeholder="例如：常用工具"></el-input>
                </el-form-item>
                <el-form-item label="模式">
                    <el-switch
                        v-model="forms.group.useEnvironments"
                        inline-prompt
                        active-text="SIT/UAT"
                        inactive-text="统一数据"
                    ></el-switch>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="dialogs.group.visible = false">取消</el-button>
                    <el-button type="primary" @click="saveGroup">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- Link Dialog -->
        <el-dialog v-model="dialogs.link.visible" :title="dialogs.link.isEdit ? '编辑链接' : '添加链接'" width="500px">
            <el-form :model="forms.link" label-width="80px">
                <el-form-item label="名称">
                    <el-input v-model="forms.link.name" placeholder="例如：GitLab"></el-input>
                </el-form-item>
                <el-form-item label="URL">
                    <el-input v-model="forms.link.url" placeholder="https://..."></el-input>
                </el-form-item>
                <el-form-item label="描述">
                    <el-input v-model="forms.link.desc" type="textarea" placeholder="简短描述"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="dialogs.link.visible = false">取消</el-button>
                    <el-button type="primary" @click="saveLink">确定</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- DB Dialog -->
        <el-dialog v-model="dialogs.db.visible" :title="dialogs.db.isEdit ? '编辑数据库' : '添加数据库'" width="500px">
            <el-form :model="forms.db" label-width="80px">
                <el-form-item label="名称">
                    <el-input v-model="forms.db.name" placeholder="例如：用户中心主库"></el-input>
                </el-form-item>
                <el-form-item label="Host">
                    <el-input v-model="forms.db.host" placeholder="192.168.x.x"></el-input>
                </el-form-item>
                <el-form-item label="Port">
                    <el-input v-model="forms.db.port" placeholder="3306"></el-input>
                </el-form-item>
                <el-form-item label="User">
                    <el-input v-model="forms.db.user" placeholder="root"></el-input>
                </el-form-item>
                <el-form-item label="Password">
                    <el-input v-model="forms.db.pass" placeholder="password"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="dialogs.db.visible = false">取消</el-button>
                    <el-button type="primary" @click="saveDb">确定</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script src="/static/js/vendor/vue.global.js"></script>
    <script src="/static/js/vendor/element-plus.js"></script>
    <script src="/static/js/vendor/axios.min.js"></script>
    <script>
    const { createApp, ref, reactive, onMounted } = Vue;
        const API_URL = '/api/v1/workspace/sites';

        const app = createApp({
            setup() {
                const workspaceData = ref([]);
                const isEditMode = ref(false);
                const currentAdminId = ref(null);
                const allowedIds = ref([]);

                // Dialog States
                const dialogs = reactive({
                    group: { visible: false, isEdit: false, index: -1 },
                    link: { visible: false, isEdit: false, groupIndex: -1, itemIndex: -1, env: 'sit' },
                    db: { visible: false, isEdit: false, groupIndex: -1, itemIndex: -1, env: 'sit' }
                });

                // Forms Data
                const forms = reactive({
                    group: { title: '', useEnvironments: true },
                    link: { name: '', url: '', desc: '' },
                    db: { name: '', host: '', port: '', user: '', pass: '' }
                });

                const ENV_DEFAULT = 'sit';
                const envOptions = [
                    { value: 'sit', label: 'SIT', icon: 'fa-solid fa-flask' },
                    { value: 'uat', label: 'UAT', icon: 'fa-solid fa-flag-checkered' }
                ];
                const activeEnvMap = reactive({});

                const deepClone = (value) => JSON.parse(JSON.stringify(value ?? null));
                const createEmptyEnv = () => ({ items: [], dbs: [] });
                const sanitizeLinkItem = (item = {}) => ({
                    name: item?.name || '',
                    url: item?.url || '',
                    desc: item?.desc || ''
                });
                const sanitizeLinkList = (items) => Array.isArray(items) ? items.map(sanitizeLinkItem) : [];

                const ensureGroupEnvironments = (group) => {
                    if (!group) return;
                    if (!group.id) {
                        group.id = `grp_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 6)}`;
                    }

                    const useEnvs = group.useEnvironments !== false;

                    if (!useEnvs) {
                        let sharedItems = Array.isArray(group.shared?.items) ? group.shared.items : null;
                        let sharedDbs = Array.isArray(group.shared?.dbs) ? group.shared.dbs : null;

                        if (!sharedItems || !sharedDbs) {
                            let sourceItems = null;
                            let sourceDbs = null;

                            if (group.environments && typeof group.environments === 'object' && !Array.isArray(group.environments)) {
                                const fallbackEnv = group.defaultEnv && group.environments[group.defaultEnv];
                                const firstEnv = fallbackEnv || group.environments[ENV_DEFAULT] || Object.values(group.environments)[0];
                                if (firstEnv) {
                                    sourceItems = firstEnv.items;
                                    sourceDbs = firstEnv.dbs;
                                }
                            } else if (group.items || group.links || group.dbs) {
                                sourceItems = group.items || group.links;
                                sourceDbs = group.dbs;
                            }

                            if (!sharedItems && Array.isArray(sourceItems)) {
                                sharedItems = deepClone(sourceItems);
                            }
                            if (!sharedDbs && Array.isArray(sourceDbs)) {
                                sharedDbs = deepClone(sourceDbs);
                            }
                        }

                        group.shared = {
                            items: sanitizeLinkList(sharedItems),
                            dbs: Array.isArray(sharedDbs) ? sharedDbs : []
                        };

                        delete group.environments;
                        delete group.items;
                        delete group.links;
                        delete group.dbs;
                        group.defaultEnv = ENV_DEFAULT;
                        return;
                    }

                    if (!group.environments || typeof group.environments !== 'object' || Array.isArray(group.environments)) {
                        group.environments = {};
                    }

                    let seedItems = [];
                    let seedDbs = [];

                    if (group.shared && typeof group.shared === 'object') {
                        if (Array.isArray(group.shared.items)) seedItems = sanitizeLinkList(group.shared.items);
                        if (Array.isArray(group.shared.dbs)) seedDbs = deepClone(group.shared.dbs);
                    } else {
                        const sourceItems = group.items || group.links;
                        if (Array.isArray(sourceItems)) seedItems = sanitizeLinkList(sourceItems);
                        if (Array.isArray(group.dbs)) seedDbs = deepClone(group.dbs);
                    }

                    envOptions.forEach(({ value }) => {
                        let envData = group.environments[value];
                        if (!envData || typeof envData !== 'object' || Array.isArray(envData)) {
                            envData = group.environments[value] = createEmptyEnv();
                        }
                        if (!Array.isArray(envData.items)) {
                            envData.items = [];
                        } else {
                            envData.items = sanitizeLinkList(envData.items);
                        }
                        if (!Array.isArray(envData.dbs)) {
                            envData.dbs = [];
                        }

                        if (!envData.items.length && seedItems.length) {
                            envData.items = sanitizeLinkList(seedItems);
                        }
                        if (!envData.dbs.length && seedDbs.length) {
                            envData.dbs = deepClone(seedDbs);
                        }
                    });

                    delete group.shared;
                    delete group.items;
                    delete group.links;
                    delete group.dbs;

                    if (!group.defaultEnv || !envOptions.some(opt => opt.value === group.defaultEnv)) {
                        group.defaultEnv = ENV_DEFAULT;
                    }
                };

                const prepareGroup = (group) => {
                    ensureGroupEnvironments(group);
                    if (group.useEnvironments === false) {
                        if (group.id) {
                            delete activeEnvMap[group.id];
                        }
                    } else if (group.id && !activeEnvMap[group.id]) {
                        activeEnvMap[group.id] = group.defaultEnv || ENV_DEFAULT;
                    }
                };

                const getActiveEnv = (group) => {
                    if (!group) return ENV_DEFAULT;
                    if (group.useEnvironments === false) {
                        return ENV_DEFAULT;
                    }
                    const fallback = envOptions.some(opt => opt.value === group?.defaultEnv)
                        ? group.defaultEnv
                        : ENV_DEFAULT;
                    if (!group.id) {
                        return fallback;
                    }
                    return activeEnvMap[group.id] || fallback;
                };

                const setGroupEnv = (group, env) => {
                    if (!group || !envOptions.some(opt => opt.value === env)) return;
                    if (group.useEnvironments === false) return;
                    if (!group.id) {
                        prepareGroup(group);
                    }
                    activeEnvMap[group.id] = env;
                    group.defaultEnv = env;
                };

                const readEnvContainer = (group, env = getActiveEnv(group)) => {
                    if (!group) return createEmptyEnv();
                    if (group.useEnvironments === false) {
                        return group.shared || createEmptyEnv();
                    }
                    if (!group.environments) return createEmptyEnv();
                    return group.environments[env] || createEmptyEnv();
                };

                const ensureEnvContainer = (group, env) => {
                    if (!group) return createEmptyEnv();
                    if (group.useEnvironments === false) {
                        if (!group.shared || typeof group.shared !== 'object') {
                            group.shared = createEmptyEnv();
                        }
                        if (!Array.isArray(group.shared.items)) {
                            group.shared.items = [];
                        } else {
                            group.shared.items = sanitizeLinkList(group.shared.items);
                        }
                        if (!Array.isArray(group.shared.dbs)) {
                            group.shared.dbs = [];
                        }
                        return group.shared;
                    }
                    if (!group.environments || typeof group.environments !== 'object') {
                        group.environments = {};
                    }
                    if (!group.environments[env]) {
                        group.environments[env] = createEmptyEnv();
                    }
                    return group.environments[env];
                };

                const getEnvItems = (group, env) => {
                    const container = readEnvContainer(group, env);
                    return sanitizeLinkList(container.items);
                };

                const getEnvDbs = (group, env) => {
                    const container = readEnvContainer(group, env);
                    return Array.isArray(container.dbs) ? container.dbs : [];
                };

                const shouldShowEnvToggle = (group) => {
                    return group?.useEnvironments !== false;
                };

                // --- Auth & Config ---
                const requestAuth = () => {
                    const input = prompt("请输入密码以进入编辑模式：");
                    if (input === null) return;
                    if (allowedIds.value.includes(input.trim())) {
                        isEditMode.value = true;
                        currentAdminId.value = input.trim();
                        ElementPlus.ElMessage.success(`欢迎, ${currentAdminId.value}。已进入编辑模式。`);
                    } else {
                        alert("验证失败");
                    }
                };

                const exitEditMode = () => {
                    isEditMode.value = false;
                    currentAdminId.value = null;
                };

                const fetchConfig = async () => {
                    try {
                        const res = await axios.get(API_URL);
                        const payload = res.data;
                        const groups = Array.isArray(payload)
                            ? payload
                            : (Array.isArray(payload?.groups) ? payload.groups : []);
                        const adminIds = Array.isArray(payload?.allowedIds)
                            ? payload.allowedIds
                                .map(id => (id == null ? '' : String(id).trim()))
                                .filter(id => id.length > 0)
                            : [];

                        allowedIds.value = adminIds;
                        workspaceData.value = groups;

                        const groupIds = new Set();
                        workspaceData.value.forEach(group => {
                            prepareGroup(group);
                            groupIds.add(group.id);
                        });

                        Object.keys(activeEnvMap).forEach(id => {
                            if (!groupIds.has(id)) {
                                delete activeEnvMap[id];
                            }
                        });
                    } catch (err) {
                        ElementPlus.ElMessage.error('加载配置失败');
                        console.error(err);
                    }
                };

                const saveConfig = async () => {
                    try {
                        workspaceData.value.forEach(prepareGroup);
                        const payload = {
                            allowedIds: [...allowedIds.value],
                            groups: JSON.parse(JSON.stringify(workspaceData.value))
                        };
                        await axios.post(API_URL, payload);
                        ElementPlus.ElMessage.success('配置已保存');
                    } catch (err) {
                        ElementPlus.ElMessage.error('保存配置失败');
                        console.error(err);
                    }
                };

                // --- Group Operations ---
                const openAddGroupDialog = () => {
                    forms.group = { title: '', useEnvironments: true };
                    dialogs.group.isEdit = false;
                    dialogs.group.index = -1;
                    dialogs.group.visible = true;
                };

                const editGroup = (index) => {
                    const group = workspaceData.value[index];
                    prepareGroup(group);
                    forms.group = {
                        title: group.title || '',
                        useEnvironments: group.useEnvironments !== false
                    };
                    dialogs.group.isEdit = true;
                    dialogs.group.index = index;
                    dialogs.group.visible = true;
                };

                const saveGroup = () => {
                    if (dialogs.group.isEdit) {
                        const group = workspaceData.value[dialogs.group.index];
                        Object.assign(group, {
                            title: forms.group.title,
                            useEnvironments: forms.group.useEnvironments !== false
                        });
                        prepareGroup(group);
                    } else {
                        const newGroup = {
                            title: forms.group.title,
                            useEnvironments: forms.group.useEnvironments !== false,
                            defaultEnv: ENV_DEFAULT,
                            shared: createEmptyEnv()
                        };
                        workspaceData.value.push(newGroup);
                        prepareGroup(newGroup);
                    }
                    dialogs.group.visible = false;
                };

                const deleteGroup = (index) => {
                    if (confirm('确定要删除这个分组吗？')) {
                        const [removed] = workspaceData.value.splice(index, 1);
                        if (removed?.id) {
                            delete activeEnvMap[removed.id];
                        }
                    }
                };

                const moveGroup = (index, direction) => {
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < workspaceData.value.length) {
                        const temp = workspaceData.value[index];
                        workspaceData.value[index] = workspaceData.value[newIndex];
                        workspaceData.value[newIndex] = temp;
                    }
                };

                // --- Link Operations ---
                const openAddLinkDialog = (groupIndex) => {
                    const group = workspaceData.value[groupIndex];
                    prepareGroup(group);
                    forms.link = { name: '', url: '', desc: '' };
                    dialogs.link.isEdit = false;
                    dialogs.link.groupIndex = groupIndex;
                    dialogs.link.itemIndex = -1;
                    dialogs.link.env = group.useEnvironments === false ? ENV_DEFAULT : getActiveEnv(group);
                    dialogs.link.visible = true;
                };

                const editLink = (groupIndex, itemIndex) => {
                    const group = workspaceData.value[groupIndex];
                    prepareGroup(group);
                    const env = getActiveEnv(group);
                    const items = getEnvItems(group, env);
                    forms.link = sanitizeLinkItem(items[itemIndex]);
                    dialogs.link.isEdit = true;
                    dialogs.link.groupIndex = groupIndex;
                    dialogs.link.itemIndex = itemIndex;
                    dialogs.link.env = group.useEnvironments === false ? ENV_DEFAULT : env;
                    dialogs.link.visible = true;
                };

                const saveLink = () => {
                    const group = workspaceData.value[dialogs.link.groupIndex];
                    prepareGroup(group);
                    const envData = ensureEnvContainer(group, dialogs.link.env);
                    const payload = sanitizeLinkItem(forms.link);

                    if (dialogs.link.isEdit && dialogs.link.itemIndex > -1) {
                        envData.items.splice(dialogs.link.itemIndex, 1, payload);
                    } else {
                        envData.items.push(payload);
                    }
                    dialogs.link.visible = false;
                };

                const deleteLink = (groupIndex, itemIndex) => {
                    if (confirm('确定删除此链接？')) {
                        const group = workspaceData.value[groupIndex];
                        prepareGroup(group);
                        const envData = ensureEnvContainer(group, getActiveEnv(group));
                        envData.items.splice(itemIndex, 1);
                    }
                };

                // --- DB Operations ---
                const openAddDbDialog = (groupIndex) => {
                    const group = workspaceData.value[groupIndex];
                    prepareGroup(group);
                    forms.db = { name: '', host: '', port: '3306', user: '', pass: '' };
                    dialogs.db.isEdit = false;
                    dialogs.db.groupIndex = groupIndex;
                    dialogs.db.itemIndex = -1;
                    dialogs.db.env = group.useEnvironments === false ? ENV_DEFAULT : getActiveEnv(group);
                    dialogs.db.visible = true;
                };

                const editDb = (groupIndex, itemIndex) => {
                    const group = workspaceData.value[groupIndex];
                    prepareGroup(group);
                    const env = getActiveEnv(group);
                    const dbs = getEnvDbs(group, env);
                    forms.db = { ...dbs[itemIndex] };
                    dialogs.db.isEdit = true;
                    dialogs.db.groupIndex = groupIndex;
                    dialogs.db.itemIndex = itemIndex;
                    dialogs.db.env = group.useEnvironments === false ? ENV_DEFAULT : env;
                    dialogs.db.visible = true;
                };

                const saveDb = () => {
                    const group = workspaceData.value[dialogs.db.groupIndex];
                    prepareGroup(group);
                    const envData = ensureEnvContainer(group, dialogs.db.env);

                    if (dialogs.db.isEdit && dialogs.db.itemIndex > -1) {
                        envData.dbs.splice(dialogs.db.itemIndex, 1, { ...forms.db });
                    } else {
                        envData.dbs.push({ ...forms.db });
                    }
                    dialogs.db.visible = false;
                };

                const deleteDb = (groupIndex, itemIndex) => {
                    if (confirm('确定删除此数据库配置？')) {
                        const group = workspaceData.value[groupIndex];
                        prepareGroup(group);
                        const envData = ensureEnvContainer(group, getActiveEnv(group));
                        envData.dbs.splice(itemIndex, 1);
                    }
                };

                const copyToClipboard = (text) => {
                    navigator.clipboard.writeText(text).then(() => {
                        ElementPlus.ElMessage.success(`已复制: ${text}`);
                    }).catch(err => console.error(err));
                };

                onMounted(() => {
                    fetchConfig();
                });

                return {
                    workspaceData, isEditMode, currentAdminId, dialogs, forms,
                    envOptions, allowedIds,
                    requestAuth, exitEditMode, saveConfig, copyToClipboard,
                    openAddGroupDialog, editGroup, saveGroup, deleteGroup, moveGroup,
                    openAddLinkDialog, editLink, saveLink, deleteLink,
                    openAddDbDialog, editDb, saveDb, deleteDb,
                    getEnvItems, getEnvDbs, setGroupEnv, getActiveEnv, shouldShowEnvToggle
                };
            }
        });
        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>