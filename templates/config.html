<!DOCTYPE html>
<html>
<head>
  <title>æ—¥å¿—é…ç½®ç¼–è¾‘</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%3Ctext%20x%3D%2750%25%27%20y%3D%2750%25%27%20text-anchor%3D%27middle%27%20dominant-baseline%3D%27central%27%20font-size%3D%2752%27%3E%E2%9A%99%EF%B8%8F%3C/text%3E%3C/svg%3E" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Noto Sans CJK SC', Arial, sans-serif; background: #f4f6fb; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 36px 40px; }
    h2 { text-align: center; color: #2d3a4b; margin-bottom: 32px; font-weight: 700; letter-spacing: 1px; }
    .msg { margin-bottom: 18px; padding: 12px; border-radius: 6px; text-align: center; font-weight: 500; display: none; }
    .msg.success { background: #e8f5e9; color: #43a047; }
    .msg.error { background: #ffebee; color: #e53935; }
    .config-info { margin-bottom: 16px; }
    .log-config-item { background: #f8fafc; border: 1px solid #e0e6ed; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .log-config-item h3 { margin: 0 0 18px 0; color: #3a4a5d; border-bottom: 1px solid #d1d9e6; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 500; color: #3a4a5d; margin-bottom: 6px; font-size: 14px; }
    .form-group input { padding: 10px 12px; border: 1px solid #d1d9e6; border-radius: 6px; font-size: 15px; background: #fff; }
    .ssh-configs-container { margin-top: 16px; }
    .ssh-config-item { display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 12px; align-items: center; background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e8eef5; }
    .ssh-config-item input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #d1d9e6; border-radius: 4px; font-size: 14px; }
    .btn { color: #fff; border: none; border-radius: 6px; padding: 10px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn-primary { background: linear-gradient(90deg, #4f8cff 0%, #2355e6 100%); box-shadow: 0 2px 8px rgba(79,140,255,0.08); }
    .btn-primary:hover { background: linear-gradient(90deg, #2355e6 0%, #4f8cff 100%); }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #e53935; font-size: 12px; padding: 6px 10px; }
    .btn-success { background: #43a047; }
    .top-actions, .bottom-actions { display: flex; gap: 18px; justify-content: flex-end; margin-bottom: 20px; }
    .placeholder-help code { background: #e8f4fd; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
  </style>
  <script>
    // API å‰ç¼€ä¸å ä½ç¬¦
    const API_PREFIX = '/api/v1';
    const PASSWORD_PLACEHOLDER = '***';
  </script>
  
</head>
<body>
  <div class="container">
    <h2>æ—¥å¿—é…ç½®ç¼–è¾‘</h2>
    <div class="config-info">
      <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 20px; padding: 10px; background: #f0f8ff; border-radius: 6px; border-left: 4px solid #4f8cff;">
        ğŸ“„ é…ç½®æ¥å£: <code id="api-endpoint">GET/PUT ${API_PREFIX}/config</code>
      </p>
    </div>
    
    <div class="placeholder-help" style="background: #f8fff8; border: 1px solid #d4edda; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 12px 0; color: #155724; font-size: 16px;">ğŸ“ æ—¥å¿—è·¯å¾„å ä½ç¬¦è¯´æ˜</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
        <div><code>{YYYY}</code> - å››ä½å¹´ä»½ (2025)</div>
        <div><code>{MM}</code> - ä¸¤ä½æœˆä»½ (08)</div>
        <div><code>{DD}</code> - ä¸¤ä½æ—¥æœŸ (11)</div>
        <div><code>{N}</code> - åºåˆ—å· (è‡ªåŠ¨æŸ¥æ‰¾æœ€å¤§å€¼)</div>
        <div><code>{YY}</code> - ä¸¤ä½å¹´ä»½ (25)</div>
        <div><code>{M}</code> - å•ä½æœˆä»½ (8)</div>
        <div><code>{D}</code> - å•ä½æ—¥æœŸ (11)</div>
        <div><code>{HH}</code> - ä¸¤ä½å°æ—¶ (14)</div>
      </div>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #c3e6cb;">
        <strong>ç¤ºä¾‹:</strong>
        <div style="margin-top: 6px; font-family: monospace; color: #0c5460;">
          <div>/logs/{YYYY}{MM}{DD}.{N}.log â†’ /logs/20250811.5.log</div>
          <div>/var/log/app-{YYYY}-{MM}-{DD}.log â†’ /var/log/app-2025-08-11.log</div>
          <div>/logs/service.{YYYY}{MM}{DD}.{N}.out â†’ /logs/service.20250811.3.out</div>
        </div>
      </div>
    </div>

    <div id="msg" class="msg"></div>
    <div id="configs-container"></div>
    <div class="top-actions">
      <button type="button" class="btn btn-success" onclick="addLogConfig()">+ æ·»åŠ ä¸€ä¸ªæ–°çš„æ—¥å¿—é…ç½®</button>
    </div>
    <div class="bottom-actions">
      <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">è¿”å›ä¸»é¡µ</button>
    </div>
  </div>

  <script>
    const container = document.getElementById('configs-container');
    const msgDiv = document.getElementById('msg');
    let currentSettings = {}; // ä¿ç•™åç«¯è¿”å›çš„ settingsï¼Œä¿å­˜æ—¶ä¸€å¹¶æäº¤

    // --- UI Rendering ---
    function createSshItem(ssh = { host: '', port: 22, username: '', password: '' }) {
      const div = document.createElement('div');
      div.className = 'ssh-config-item';
      const pwdValue = ssh.password ? ssh.password : '';
      const isMasked = pwdValue === PASSWORD_PLACEHOLDER;
      div.innerHTML = `
        <input type="text" placeholder="ä¸»æœº" value="${ssh.host || ''}" data-key="host">
        <input type="number" placeholder="ç«¯å£" value="${ssh.port || 22}" data-key="port">
        <input type="text" placeholder="ç”¨æˆ·å" value="${ssh.username || ''}" data-key="username">
        <input type="password" placeholder="å¯†ç ï¼ˆä¸ä¿®æ”¹åˆ™ç•™ç©ºï¼‰" value="${isMasked ? '' : (pwdValue || '')}" data-key="password">
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
      `;
      return div;
    }

    function createLogConfigItem(log = { name: '', path: '', description: '', group: '', sshs: [] }) {
      const div = document.createElement('div');
      div.className = 'log-config-item';
      div.innerHTML = `
        <h3>
          <span>æ—¥å¿—é…ç½®</span>
          <button type="button" class="btn btn-danger" onclick="this.closest('.log-config-item').remove()">åˆ é™¤æ­¤é…ç½®</button>
        </h3>
        <div class="form-grid-3">
          <div class="form-group">
            <label>åç§° (Name)</label>
            <input type="text" placeholder="ä¾‹å¦‚ï¼šæœåŠ¡Aæ—¥å¿—" value="${log.name || ''}" data-key="name">
          </div>
          <div class="form-group">
            <label>åˆ†ç»„ (Groupï¼Œå¯é€‰)</label>
            <input type="text" placeholder="SIT/UAT/DEV" value="${log.group || ''}" data-key="group">
          </div>
          <div class="form-group">
            <label>æè¿° (Descriptionï¼Œå¯é€‰)</label>
            <input type="text" placeholder="ä¾‹å¦‚ï¼šæœåŠ¡Aå…³é”®æ—¥å¿—" value="${log.description || ''}" data-key="description">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>è·¯å¾„ (Path)</label>
            <input type="text" placeholder="ä¾‹å¦‚ï¼š/path/to/YYYYMMDD.N.log" value="${log.path || ''}" data-key="path">
          </div>
          <div></div>
        </div>
        <h4>SSH è¿æ¥</h4>
        <div class="ssh-configs-container"></div>
        <button type="button" class="btn btn-success" style="font-size:12px; padding: 6px 12px; margin-top:10px;" onclick="this.previousElementSibling.appendChild(createSshItem())">+ æ·»åŠ SSHè¿æ¥</button>
      `;
      const sshContainer = div.querySelector('.ssh-configs-container');
      (log.sshs || []).forEach(ssh => sshContainer.appendChild(createSshItem(ssh)));
      if (!log.sshs || log.sshs.length === 0) {
        sshContainer.appendChild(createSshItem());
      }
      return div;
    }

    function render(data) {
      container.innerHTML = '';
      (data.logs || []).forEach(log => {
        container.appendChild(createLogConfigItem(log));
      });
      if (!data.logs || data.logs.length === 0) {
        addLogConfig();
      }
    }

    function addLogConfig() {
      container.appendChild(createLogConfigItem({ name: '', path: '', description: '', group: '', sshs: [{ host: '', port: 22, username: '', password: '' }] }));
    }

    // --- Data Handling & API Calls ---
    async function fetchConfig() {
      try {
        const res = await fetch(`${API_PREFIX}/config`);
        if (!res.ok) throw new Error(`åŠ è½½é…ç½®å¤±è´¥: ${res.status} ${res.statusText}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error?.message || 'åŠ è½½é…ç½®å¤±è´¥');
        const data = json.data || {};
        currentSettings = data.settings || {};
        // åç«¯å·²å¯¹å¯†ç åšäº†è„±æ•å¤„ç†ï¼›renderæ—¶è¾“å…¥æ¡†é»˜è®¤ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹
        render(data);
        showMessage('é…ç½®å·²åŠ è½½', 'success');
      } catch (e) {
        showMessage(`åŠ è½½é…ç½®å¤±è´¥: ${e.message}`, 'error');
      }
    }

    async function saveConfig() {
      try {
        const logs = [];
        document.querySelectorAll('.log-config-item').forEach(logItem => {
          const log = {
            name: logItem.querySelector('[data-key="name"]').value.trim(),
            path: logItem.querySelector('[data-key="path"]').value.trim(),
            group: logItem.querySelector('[data-key="group"]').value.trim(),
            description: logItem.querySelector('[data-key="description"]').value.trim(),
            sshs: []
          };
          logItem.querySelectorAll('.ssh-config-item').forEach(sshItem => {
            const pwd = (sshItem.querySelector('[data-key="password"]').value || '').trim();
            const ssh = {
              host: sshItem.querySelector('[data-key="host"]').value.trim(),
              port: parseInt(sshItem.querySelector('[data-key="port"]').value, 10) || 22,
              username: sshItem.querySelector('[data-key="username"]').value.trim(),
            };
            // åªæœ‰åœ¨ç”¨æˆ·å¡«å†™äº†å¯†ç æ—¶æ‰æäº¤å¯†ç å­—æ®µï¼Œç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹ï¼ˆæœåŠ¡å™¨ç«¯ä¼šåˆå¹¶æ—§å¯†ç ï¼‰
            if (pwd) ssh.password = pwd;
            log.sshs.push(ssh);
          });
          logs.push(log);
        });

        // åŸºæœ¬æ ¡éªŒ
        for (const [i, log] of logs.entries()) {
          if (!log.name) throw new Error(`ç¬¬ ${i + 1} ä¸ªé…ç½®ç¼ºå°‘åç§°`);
          if (!log.path) throw new Error(`ç¬¬ ${i + 1} ä¸ªé…ç½®ç¼ºå°‘è·¯å¾„`);
        }

        const payload = { logs, settings: currentSettings };
        const res = await fetch(`${API_PREFIX}/config`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.error?.message || `ä¿å­˜å¤±è´¥: ${res.status} ${res.statusText}`);
        }
        showMessage(json.data?.message || 'ä¿å­˜æˆåŠŸ', 'success');
        // é‡æ–°åŠ è½½ä»¥æ‹¿åˆ°è„±æ•åçš„å±•ç¤º
        fetchConfig();
      } catch (e) {
        showMessage(`ä¿å­˜å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function showMessage(text, type = 'error') {
        msgDiv.textContent = text;
        msgDiv.className = `msg ${type}`;
        msgDiv.style.display = 'block';
        clearTimeout(msgDiv._timer);
        msgDiv._timer = setTimeout(() => { msgDiv.style.display = 'none'; }, 4000);
    }

    // Initial Load
    fetchConfig();
  </script>
</body>
</html>
