name: build-windows-exe

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install build deps
        run: |
          pip install -r requirements.txt
          pip install pyinstaller==6.8.0

      - name: Show Python info
        run: |
          python --version
          python -c "import sys; print(sys.platform)"

      - name: Build (onedir) via CLI (no spec)
        run: |
          pyinstaller \
            --name log-search-api \
            --onedir \
            --noconfirm \
            --clean \
            --add-data "templates;templates" \
            --add-data "static;static" \
            --additional-hooks-dir pyinstaller-hooks \
            --hidden-import engineio \
            --hidden-import socketio \
            --hidden-import engineio.async_drivers.threading \
            --hidden-import socketio.async_drivers.threading \
            --collect-all paramiko \
            main.py

      - name: Rename onedir folder
        run: |
          mkdir -p artifacts
          mv dist/log-search-api artifacts/log-search-api-onedir
          # 复制启动和停止脚本到onedir版本
          cp start.bat artifacts/log-search-api-onedir/

      - name: Build (onefile) without spec
        run: |
          pyinstaller \
            --name log-search-api \
            --onefile \
            --noconfirm \
            --clean \
            --add-data "templates;templates" \
            --add-data "static;static" \
            --additional-hooks-dir pyinstaller-hooks \
            --hidden-import engineio \
            --hidden-import socketio \
            --hidden-import engineio.async_drivers.threading \
            --hidden-import socketio.async_drivers.threading \
            --collect-all paramiko \
            main.py

      - name: Move onefile exe
        run: |
          mv dist/log-search-api.exe artifacts/log-search-api-onefile.exe
          # 复制启动和停止脚本到onefile版本同目录
          cp start.bat artifacts/

      - name: Archive onedir
        shell: pwsh
        run: |
          Set-Location artifacts
          if (Test-Path log-search-api-onedir.zip) { Remove-Item log-search-api-onedir.zip }
          Compress-Archive -Path 'log-search-api-onedir/*' -DestinationPath 'log-search-api-onedir.zip'

      - name: Create deployment package
        shell: pwsh
        run: |
          Set-Location artifacts
          # 创建部署包目录
          New-Item -ItemType Directory -Name "deployment" -Force
          
          # 复制onefile版本和脚本
          Copy-Item "log-search-api-onefile.exe" "deployment/log-search-api.exe"
          Copy-Item "start.bat" "deployment/"
          
          # 创建部署包zip
          if (Test-Path deployment.zip) { Remove-Item deployment.zip }
          Compress-Archive -Path 'deployment/*' -DestinationPath 'deployment.zip'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-executables
          path: |
            artifacts/log-search-api-onefile.exe
            artifacts/start.bat
            artifacts/log-search-api-onedir.zip
            artifacts/deployment.zip
