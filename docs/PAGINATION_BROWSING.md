# 日志分页浏览功能说明

## 功能概述

日志搜索结果现在支持**正序/倒序分页加载**功能，可以优雅地浏览大量日志数据，而不会一次性渲染所有结果导致性能问题。

## 核心特性

### 1. 分页加载机制
- **初始加载**：每个主机默认只加载前 100 行日志（可配置）
- **按需加载**：滚动到边缘时自动加载下一批数据
- **性能优化**：避免一次性渲染数万条日志导致的卡顿

### 2. 两种浏览模式

#### 正序浏览（⬇️）
- **起点**：从日志文件的开头开始
- **滚动方向**：向下滚动查看更新的日志
- **触发加载**：滚动到底部时自动加载下一批
- **适用场景**：查看日志的完整历史，从最早的记录开始分析

#### 倒序浏览（⬆️）
- **起点**：从日志文件的末尾开始
- **滚动方向**：向上滚动查看更早的日志
- **触发加载**：滚动到顶部时自动加载上一批
- **适用场景**：查看最新日志，从最近的记录开始排查
- **视觉保持**：在顶部加载新内容时，自动调整滚动位置，避免视图跳动

## 使用方法

### 切换浏览模式

在每个主机结果框的头部，有两个按钮：

1. **⬇️ 正序按钮**：点击切换到正序浏览模式
   - 按钮激活状态显示高亮
   - 自动滚动到顶部
   - 后续可向下滚动加载更多

2. **⬆️ 倒序按钮**：点击切换到倒序浏览模式
   - 按钮激活状态显示高亮
   - 自动滚动到底部
   - 后续可向上滚动加载更多

### 按钮位置

- **正常视图**：按钮在主机头部右侧，在文件管理、终端等按钮之前
- **折叠视图**：按钮在"更多操作"菜单中，位于菜单顶部

## 技术实现

### 数据结构

```javascript
paginationState = {
  [groupKey]: {
    mode: 'forward' | 'reverse',  // 浏览模式
    loadedStart: number,           // 已加载的起始行号
    loadedEnd: number,             // 已加载的结束行号
    pageSize: 100,                 // 每次加载的行数
    total: number,                 // 总行数
    loading: boolean               // 是否正在加载
  }
}
```

### 核心方法

1. **initializePagination()**
   - 在搜索结果更新时调用
   - 为每个主机初始化分页状态
   - 默认设置为正序模式，加载前 100 行

2. **setBrowseMode(groupKey, mode)**
   - 切换浏览模式
   - 重新计算加载范围
   - 调整滚动位置

3. **loadMoreForward(groupKey)**
   - 正序模式下加载更多
   - 在底部追加新行

4. **loadMoreReverse(groupKey)**
   - 倒序模式下加载更多
   - 在顶部插入新行
   - 保持视图位置不变

5. **handleGroupScroll(event)**
   - 监听滚动事件
   - 判断触顶/触底
   - 触发相应的加载方法

### 视图保持算法（倒序模式）

```javascript
// 记录插入前的状态
const oldScrollHeight = container.scrollHeight;
const oldScrollTop = container.scrollTop;

// 插入新内容
// ... 更新 visibleLines ...

// 调整滚动位置，使视觉保持不变
this.$nextTick(() => {
  const newScrollHeight = container.scrollHeight;
  container.scrollTop = newScrollHeight - oldScrollHeight + oldScrollTop;
});
```

## 配置参数

在 `LogSearchResults.js` 的 `CONSTANTS` 中可配置：

```javascript
CONSTANTS: {
  PAGE_SIZE: 100,           // 每次加载的行数（默认 100）
  SCROLL_THRESHOLD: 60      // 触发加载的滚动阈值（像素，默认 60）
}
```

## 兼容性

- ✅ 支持单主机和多主机分组显示
- ✅ 兼容全屏模式
- ✅ 兼容语法高亮
- ✅ 兼容关键词搜索高亮
- ✅ 支持折叠/展开菜单
- ✅ 不影响下载、SFTP、终端等其他功能

## 性能优化

1. **按需渲染**：只渲染可视区域及附近的日志行
2. **异步加载**：使用 `setTimeout` 模拟异步，避免阻塞 UI
3. **防抖处理**：`loading` 标志防止重复加载
4. **被动监听**：滚动监听使用 `{ passive: true }` 提升性能

## 示例场景

### 场景 1：排查最新错误
1. 搜索关键词 "ERROR"
2. 点击 **⬆️ 倒序** 按钮
3. 查看最新的错误日志
4. 向上滚动查看更早的错误

### 场景 2：追踪问题起因
1. 搜索关键词 "transaction_id:12345"
2. 点击 **⬇️ 正序** 按钮
3. 从事务开始查看完整流程
4. 向下滚动追踪整个生命周期

### 场景 3：大量结果快速浏览
1. 搜索高频关键词（如 "INFO"）
2. 使用分页加载，避免浏览器卡顿
3. 根据时间顺序选择合适的浏览模式

## 注意事项

1. **模式切换**：切换模式时会重新计算可见范围，当前滚动位置会重置
2. **加载指示**：暂无明显的加载指示器，加载过程非常快速（50ms）
3. **总行数限制**：受 `maxResults` prop 限制（默认 5000 行）
4. **初始模式**：默认为正序模式

## 未来增强

- [ ] 添加加载指示器（loading spinner）
- [ ] 支持跳转到指定行号
- [ ] 支持虚拟滚动（大数据量时进一步优化）
- [ ] 添加加载进度提示
- [ ] 支持配置每次加载的行数
