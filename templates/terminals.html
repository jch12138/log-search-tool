<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在线终端</title>
  <link rel="icon" type="image/svg+xml" href="/static/icons/favicon-terminal.svg" />
  <link rel="stylesheet" href="/static/fonts/source-code-pro.css" />
  <link rel="stylesheet" href="/static/css/xterm.css" />
  <style>
    html,body { margin:0; padding:0; height:100%; width:100%; background:#0a0e1a; font-family: 'Source Code Pro','Consolas','Monaco','Menlo',monospace; }
    body { display:flex; }
    .viewport { flex:1; display:flex; padding:0; margin:0; overflow:hidden; }
    #panel { flex:1; display:flex; position:relative; }
    .term { flex:1; width:100%; height:100%; }
    .placeholder { color:#64748b; margin:auto; font-size:14px; letter-spacing:.5px; text-align:center; line-height:1.6; }
    .xterm .xterm-viewport::-webkit-scrollbar { width:8px; height:8px; }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb { background:rgba(255,255,255,.15); border-radius:8px; }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,.28); }
  </style>
</head>
<body>
  <div class="viewport">
    <div id="panel">
      <div class="placeholder" id="placeholder">等待连接<br/>请通过 URL 指定 ?log_name=xxx&ssh_index=N 或 single 模式</div>
    </div>
  </div>

  <script src="/static/js/vendor/xterm.min.js"></script>
  <script src="/static/js/vendor/xterm-addon-fit.min.js"></script>
  <script src="/static/js/vendor/socket.io.min.js"></script>
  <script>
    const API = '/api/v1';
    const state = { current:null, sessions:{}, socket:null };

    function $(id){ return document.getElementById(id); }

    function updateTitle(u,h){ if(u&&h){ document.title = `${u}@${h}`; } }

    function showError(msg){
      const panel = document.getElementById('panel');
      let ph = document.getElementById('placeholder');
      if(!ph){
        ph = document.createElement('div');
        ph.id = 'placeholder';
        ph.className = 'placeholder';
        panel.appendChild(ph);
      }
      ph.textContent = msg;
    }

    async function connectByConfig(logName, sshIndex){
      try {
        const payload = { log_name: logName, ssh_index: sshIndex };
        const r = await fetch(`${API}/terminals`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await r.json();
        if(!j.success) throw new Error(j.error?.message||'连接失败');
        const d = j.data;
        updateTitle(d.username, d.host);

        // init terminal
        const term = new window.Terminal({
          cursorBlink:true,
          convertEol:true,
          fontFamily:"'Source Code Pro','Consolas','Monaco','Menlo',monospace",
          fontSize:14,
          theme:{ background:'#0a0e1a', foreground:'#e2e8f0' },
          scrollback:10000
        });
        const fitAddon = new window.FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        const el = document.createElement('div');
        el.className='term';
        el.id = `term-${d.terminal_id}`;
        const panel = document.getElementById('panel');
        // 清空仅在成功后
        panel.innerHTML='';
        panel.appendChild(el);
        term.open(el);
        setTimeout(()=>{ try{ fitAddon.fit(); }catch(e){} }, 50);
        if(d.initial_prompt){ term.write(d.initial_prompt.replace(/\n/g,'\r\n')); }
        term.onData(data => { if(state.socket){ state.socket.emit('input', { terminal_id: d.terminal_id, data }); }});
        if(state.socket){ state.socket.emit('join', { terminal_id: d.terminal_id }); }
        state.sessions[d.terminal_id] = { term, fitAddon };
        state.current = d.terminal_id;
        window.addEventListener('resize', ()=>{ if(fitAddon) { try{ fitAddon.fit(); }catch(e){} } });
      } catch(e){ showError('连接失败: '+e.message); }
    }

    async function connectByServerId(serverId){
      try {
        const payload = { server_id: serverId };
        const r = await fetch(`${API}/terminals/connect-by-config`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await r.json();
        if(!j.success) throw new Error(j.error?.message||'连接失败');
        const d = j.data;
        updateTitle(d.username, d.host);
        const term = new window.Terminal({
          cursorBlink:true,
          convertEol:true,
          fontFamily:"'Source Code Pro','Consolas','Monaco','Menlo',monospace",
            fontSize:14,
            theme:{ background:'#0a0e1a', foreground:'#e2e8f0' },
            scrollback:10000
          });
        const fitAddon = new window.FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        const el = document.createElement('div');
        el.className='term';
        el.id = `term-${d.terminal_id}`;
        const panel = document.getElementById('panel');
        panel.innerHTML='';
        panel.appendChild(el);
        term.open(el);
        setTimeout(()=>{ try{ fitAddon.fit(); }catch(e){} }, 50);
        if(d.initial_prompt){ term.write(d.initial_prompt.replace(/\n/g,'\r\n')); }
        term.onData(data => { if(state.socket){ state.socket.emit('input', { terminal_id: d.terminal_id, data }); }});
        if(state.socket){ state.socket.emit('join', { terminal_id: d.terminal_id }); }
        state.sessions[d.terminal_id] = { term, fitAddon };
        state.current = d.terminal_id;
        window.addEventListener('resize', ()=>{ if(fitAddon){ try{ fitAddon.fit(); }catch(e){} } });
      } catch(e) { showError('连接失败: '+e.message); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      state.socket = io('/', { path:'/socket.io', transports:['websocket'] });
      state.socket.on('output', msg => {
        const { terminal_id, data } = msg || {}; if(!terminal_id) return; const s = state.sessions[terminal_id]; if(!s) return; if(data){ s.term.write(String(data).replace(/\n/g,'\r\n')); }
      });
      const params = new URLSearchParams(window.location.search);
      const logName = params.get('log_name');
      const sshIndex = params.get('ssh_index');
      const serverId = params.get('server_id');
      if (logName && logName.trim() !== '' && sshIndex !== null) {
        connectByConfig(logName.trim(), parseInt(sshIndex,10)||0);
      } else if (serverId) {
        connectByServerId(serverId);
      } else if (params.get('single')==='1') {
        const ln = (logName||'').trim();
        if (ln) { const si = parseInt(sshIndex||'0',10)||0; connectByConfig(ln, si); }
        else if (serverId) { connectByServerId(serverId); }
        else { $('#placeholder').innerHTML = '缺少 log_name 或 server_id 参数<br/>无法自动连接'; }
      }
    });

    window.addEventListener('beforeunload', ()=>{
      const ids = Object.keys(state.sessions);
      ids.forEach(id=>{ try{ fetch(`${API}/terminals/${id}`, { method:'DELETE', keepalive:true }); }catch(e){} });
    });
  </script>
</body>
</html>